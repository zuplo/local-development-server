var ur=Object.defineProperty;var e=(t,r)=>ur(t,"name",{value:r,configurable:!0});import{bundle as Kr,transpile as Yr}from"https://deno.land/x/emit@0.29.0/mod.ts";import{load as Ce}from"https://deno.land/std@0.203.0/dotenv/mod.ts";import{createOAuth2Token as Hr}from"https://deno.land/x/deno_gcp_admin@0.0.5/auth.ts";import{parse as ze}from"https://deno.land/std@0.203.0/flags/mod.ts";import{Server as Ge}from"https://deno.land/std@0.203.0/http/server.ts";import*as q from"https://deno.land/std@0.203.0/fs/mod.ts";import*as oe from"https://deno.land/std@0.203.0/http/http_status.ts";import*as x from"https://deno.land/std@0.203.0/log/mod.ts";import*as G from"https://deno.land/std@0.203.0/path/mod.ts";import{deferred as et}from"https://deno.land/std@0.203.0/async/deferred.ts";import{assert as tt,assertAlmostEquals as nt,assertArrayIncludes as it,assertEquals as ot,assertExists as st,assertFalse as at,assertInstanceOf as ut,assertIsError as ct,assertMatch as lt,assertNotEquals as ft,assertNotMatch as dt,assertNotStrictEquals as pt,assertObjectMatch as yt,assertRejects as mt,assertStrictEquals as gt,assertStringIncludes as _t,assertThrows as ht,equal as Et,fail as vt,unimplemented as Ot,unreachable as Lt}from"https://deno.land/std@0.203.0/assert/mod.ts";import{afterAll as bt,afterEach as Tt,beforeAll as Pt,beforeEach as wt,describe as Mt,it as Dt}from"https://deno.land/std@0.203.0/testing/bdd.ts";var cr=Object.getOwnPropertyNames,I=e((t,r)=>e(function(){return r||(0,t[cr(t)[0]])((r={exports:{}}).exports,r),r.exports},"__require"),"__commonJS"),lr=I({"node_modules/secure-json-parse/index.js"(t,r){"use strict";var o=typeof Buffer<"u",i=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,c=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function s(g,P,L){L==null&&P!==null&&typeof P=="object"&&(L=P,P=void 0),o&&Buffer.isBuffer(g)&&(g=g.toString()),g&&g.charCodeAt(0)===65279&&(g=g.slice(1));let f=JSON.parse(g,P);if(f===null||typeof f!="object")return f;let S=L&&L.protoAction||"error",n=L&&L.constructorAction||"error";if(S==="ignore"&&n==="ignore")return f;if(S!=="ignore"&&n!=="ignore"){if(i.test(g)===!1&&c.test(g)===!1)return f}else if(S!=="ignore"&&n==="ignore"){if(i.test(g)===!1)return f}else if(c.test(g)===!1)return f;return u(f,{protoAction:S,constructorAction:n,safe:L&&L.safe})}e(s,"_parse");function u(g,{protoAction:P="error",constructorAction:L="error",safe:f}={}){let S=[g];for(;S.length;){let n=S;S=[];for(let m of n){if(P!=="ignore"&&Object.prototype.hasOwnProperty.call(m,"__proto__")){if(f===!0)return null;if(P==="error")throw new SyntaxError("Object contains forbidden prototype property");delete m.__proto__}if(L!=="ignore"&&Object.prototype.hasOwnProperty.call(m,"constructor")&&Object.prototype.hasOwnProperty.call(m.constructor,"prototype")){if(f===!0)return null;if(L==="error")throw new SyntaxError("Object contains forbidden prototype property");delete m.constructor}for(let _ in m){let p=m[_];p&&typeof p=="object"&&S.push(p)}}}return g}e(u,"filter");function l(g,P,L){let f=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(g,P,L)}finally{Error.stackTraceLimit=f}}e(l,"parse");function h(g,P){let L=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(g,P,{safe:!0})}catch{return null}finally{Error.stackTraceLimit=L}}e(h,"safeParse"),r.exports=l,r.exports.default=l,r.exports.parse=l,r.exports.safeParse=h,r.exports.scan=u}}),Ve=I({"lib/utils/is-object.js"(t,r){"use strict";r.exports=o;function o(i){return Object.prototype.toString.apply(i)==="[object Object]"}e(o,"isObject")}}),se=I({"lib/constants.js"(t,r){"use strict";r.exports={DATE_FORMAT:"yyyy-mm-dd HH:MM:ss.l o",DATE_FORMAT_SIMPLE:"HH:MM:ss.l",ERROR_LIKE_KEYS:["err","error"],MESSAGE_KEY:"msg",LEVEL_KEY:"level",LEVEL_LABEL:"levelLabel",TIMESTAMP_KEY:"time",LEVELS:{default:"USERLVL",60:"FATAL",50:"ERROR",40:"WARN",30:"INFO",20:"DEBUG",10:"TRACE"},LEVEL_NAMES:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},LOGGER_KEYS:["pid","hostname","name","level","time","timestamp","caller"]}}}),Ne=I({"lib/utils/join-lines-with-indentation.js"(t,r){"use strict";r.exports=o;function o({input:i,ident:c="    ",eol:s=`
`}){let u=i.split(/\r?\n/);for(let l=1;l<u.length;l+=1)u[l]=c+u[l];return u.join(s)}e(o,"joinLinesWithIndentation")}}),fr=I({"node_modules/fast-safe-stringify/index.js"(t,r){r.exports=l,l.default=l,l.stable=L,l.stableStringify=L;var o="[...]",i="[Circular]",c=[],s=[];function u(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}e(u,"defaultOptions");function l(n,m,_,p){typeof p>"u"&&(p=u()),g(n,"",0,[],void 0,0,p);var v;try{s.length===0?v=JSON.stringify(n,m,_):v=JSON.stringify(n,S(m),_)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;c.length!==0;){var O=c.pop();O.length===4?Object.defineProperty(O[0],O[1],O[3]):O[0][O[1]]=O[2]}}return v}e(l,"stringify");function h(n,m,_,p){var v=Object.getOwnPropertyDescriptor(p,_);v.get!==void 0?v.configurable?(Object.defineProperty(p,_,{value:n}),c.push([p,_,m,v])):s.push([m,_,n]):(p[_]=n,c.push([p,_,m]))}e(h,"setReplace");function g(n,m,_,p,v,O,M){O+=1;var T;if(typeof n=="object"&&n!==null){for(T=0;T<p.length;T++)if(p[T]===n){h(i,n,m,v);return}if(typeof M.depthLimit<"u"&&O>M.depthLimit){h(o,n,m,v);return}if(typeof M.edgesLimit<"u"&&_+1>M.edgesLimit){h(o,n,m,v);return}if(p.push(n),Array.isArray(n))for(T=0;T<n.length;T++)g(n[T],T,T,p,n,O,M);else{var y=Object.keys(n);for(T=0;T<y.length;T++){var E=y[T];g(n[E],E,T,p,n,O,M)}}p.pop()}}e(g,"decirc");function P(n,m){return n<m?-1:n>m?1:0}e(P,"compareFunction");function L(n,m,_,p){typeof p>"u"&&(p=u());var v=f(n,"",0,[],void 0,0,p)||n,O;try{s.length===0?O=JSON.stringify(v,m,_):O=JSON.stringify(v,S(m),_)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;c.length!==0;){var M=c.pop();M.length===4?Object.defineProperty(M[0],M[1],M[3]):M[0][M[1]]=M[2]}}return O}e(L,"deterministicStringify");function f(n,m,_,p,v,O,M){O+=1;var T;if(typeof n=="object"&&n!==null){for(T=0;T<p.length;T++)if(p[T]===n){h(i,n,m,v);return}try{if(typeof n.toJSON=="function")return}catch{return}if(typeof M.depthLimit<"u"&&O>M.depthLimit){h(o,n,m,v);return}if(typeof M.edgesLimit<"u"&&_+1>M.edgesLimit){h(o,n,m,v);return}if(p.push(n),Array.isArray(n))for(T=0;T<n.length;T++)f(n[T],T,T,p,n,O,M);else{var y={},E=Object.keys(n).sort(P);for(T=0;T<E.length;T++){var w=E[T];f(n[w],w,T,p,n,O,M),y[w]=n[w]}if(typeof v<"u")c.push([v,m,n]),v[m]=y;else return y}p.pop()}}e(f,"deterministicDecirc");function S(n){return n=typeof n<"u"?n:function(m,_){return _},function(m,_){if(s.length>0)for(var p=0;p<s.length;p++){var v=s[p];if(v[1]===m&&v[0]===_){_=v[2],s.splice(p,1);break}}return n.call(this,m,_)}}e(S,"replaceGetterValues")}}),dr=I({"lib/utils/prettify-error.js"(t,r){"use strict";r.exports=i;var o=Ne();function i({keyName:c,lines:s,eol:u,ident:l}){let h="",g=o({input:s,ident:l,eol:u}),P=`${l}${c}: ${g}${u}`.split(u);for(let L=0;L<P.length;L+=1){L!==0&&(h+=u);let f=P[L];if(/^\s*"stack"/.test(f)){let S=/^(\s*"stack":)\s*(".*"),?$/.exec(f);if(S&&S.length===3){let n=/^\s*/.exec(f)[0].length+4,m=" ".repeat(n),_=S[2];h+=S[1]+u+m+JSON.parse(_).replace(/\n/g,u+m)}else h+=f}else h+=f}return h}e(i,"prettifyError")}}),Ke=I({"lib/utils/prettify-object.js"(t,r){"use strict";r.exports=u;var{LOGGER_KEYS:o}=se(),i=fr(),c=Ne(),s=dr();function u({log:l,excludeLoggerKeys:h=!0,skipKeys:g=[],context:P}){let{EOL:L,IDENT:f,customPrettifiers:S,errorLikeObjectKeys:n,objectColorizer:m,singleLine:_}=P,p=[].concat(g);h===!0&&Array.prototype.push.apply(p,o);let v="",{plain:O,errors:M}=Object.entries(l).reduce(({plain:T,errors:y},[E,w])=>{if(p.includes(E)===!1){let D=typeof S[E]=="function"?S[E](w,E,l):w;n.includes(E)?y[E]=D:T[E]=D}return{plain:T,errors:y}},{plain:{},errors:{}});return _?(Object.keys(O).length>0&&(v+=m.greyMessage(i(O))),v+=L,v=v.replace(/\\\\/gi,"\\")):Object.entries(O).forEach(([T,y])=>{let E=typeof S[T]=="function"?y:i(y,null,2);if(E===void 0)return;E=E.replace(/\\\\/gi,"\\");let w=c({input:E,ident:f,eol:L});v+=`${f}${T}:${w.startsWith(L)?"":" "}${w}${L}`}),Object.entries(M).forEach(([T,y])=>{let E=typeof S[T]=="function"?y:i(y,null,2);E!==void 0&&(v+=s({keyName:T,lines:E,eol:L,ident:f}))}),v}e(u,"prettifyObject")}}),pr=I({"lib/utils/prettify-error-log.js"(t,r){"use strict";r.exports=u;var{LOGGER_KEYS:o}=se(),i=Ve(),c=Ne(),s=Ke();function u({log:l,context:h}){let{EOL:g,IDENT:P,errorProps:L,messageKey:f}=h,S=l.stack,n=c({input:S,ident:P,eol:g}),m=`${P}${n}${g}`;if(L.length>0){let _=o.concat(f,"type","stack"),p;L[0]==="*"?p=Object.keys(l).filter(v=>_.includes(v)===!1):p=L.filter(v=>_.includes(v)===!1);for(let v=0;v<p.length;v+=1){let O=p[v];if(O in l){if(i(l[O])){let M=s({log:l[O],excludeLoggerKeys:!1,context:{...h,IDENT:P+P}});m=`${m}${P}${O}: {${g}${M}${P}}${g}`;continue}m=`${m}${P}${O}: ${l[O]}${g}`}}}return m}e(u,"prettifyErrorLog")}}),Ye=I({"lib/utils/split-property-key.js"(t,r){"use strict";r.exports=o;function o(i){let c=[],s=!1,u="";for(let l=0;l<i.length;l++){let h=i.charAt(l);if(h==="\\"){s=!0;continue}if(s){s=!1,u+=h;continue}if(h==="."){c.push(u),u="";continue}u+=h}return u.length&&c.push(u),c}e(o,"splitPropertyKey")}}),pe=I({"lib/utils/get-property-value.js"(t,r){"use strict";r.exports=i;var o=Ye();function i(c,s){let u=Array.isArray(s)?s:o(s);for(let l of u){if(!Object.prototype.hasOwnProperty.call(c,l))return;c=c[l]}return c}e(i,"getPropertyValue")}}),yr=I({"lib/utils/prettify-level.js"(t,r){"use strict";r.exports=i;var o=pe();function i({log:c,context:s}){let{colorizer:u,customLevels:l,customLevelNames:h,levelKey:g}=s,P=s.customPrettifiers?.level,L=o(c,g);if(L!==void 0)return P?P(L):u(L,{customLevels:l,customLevelNames:h})}e(i,"prettifyLevel")}}),mr=I({"lib/utils/interpret-conditionals.js"(t,r){"use strict";r.exports=i;var o=pe();function i(c,s){return c=c.replace(/{if (.*?)}(.*?){end}/g,u),c=c.replace(/{if (.*?)}/g,""),c=c.replace(/{end}/g,""),c.replace(/\s+/g," ").trim();function u(l,h,g){let P=o(s,h);return P&&g.includes(h)?g.replace(new RegExp("{"+h+"}","g"),P):""}e(u,"replacer")}e(i,"interpretConditionals")}}),gr=I({"lib/utils/prettify-message.js"(t,r){"use strict";r.exports=s;var{LEVELS:o}=se(),i=pe(),c=mr();function s({log:u,context:l}){let{colorizer:h,customLevels:g,levelKey:P,levelLabel:L,messageFormat:f,messageKey:S,useOnlyCustomProps:n}=l;if(f&&typeof f=="string"){let m=c(f,u),_=String(m).replace(/{([^{}]+)}/g,function(p,v){let O;return v===L&&(O=i(u,P))!==void 0?(n?g===void 0:g[O]===void 0)?o[O]:g[O]:i(u,v)||""});return h.message(_)}if(f&&typeof f=="function"){let m=f(u,S,L);return h.message(m)}if(S in u&&!(typeof u[S]!="string"&&typeof u[S]!="number"&&typeof u[S]!="boolean"))return h.message(u[S])}e(s,"prettifyMessage")}}),_r=I({"lib/utils/prettify-metadata.js"(t,r){"use strict";r.exports=o;function o({log:i,context:c}){let s=c.customPrettifiers,u="";if(i.name||i.pid||i.hostname){if(u+="(",i.name&&(u+=s.name?s.name(i.name):i.name),i.pid){let l=s.pid?s.pid(i.pid):i.pid;i.name&&i.pid?u+="/"+l:u+=l}i.hostname&&(u+=`${u==="("?"on":" on"} ${s.hostname?s.hostname(i.hostname):i.hostname}`),u+=")"}if(i.caller&&(u+=`${u===""?"":" "}<${s.caller?s.caller(i.caller):i.caller}>`),u!=="")return u}e(o,"prettifyMetadata")}}),hr=I({"node_modules/dateformat/lib/dateformat.js"(t,r){"use strict";function o(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?o=e(function(s){return typeof s},"_typeof2"):o=e(function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},"_typeof2"),o(i)}e(o,"_typeof"),function(i){var c=arguments,s=function(){var L=/d{1,4}|D{3,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|W{1,2}|[LlopSZN]|"[^"]*"|'[^']*'/g,f=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,S=/[^-+\dA-Z]/g;return function(n,m,_,p){if(c.length===1&&P(n)==="string"&&!/\d/.test(n)&&(m=n,n=void 0),n=n||n===0?n:new Date,n instanceof Date||(n=new Date(n)),isNaN(n))throw TypeError("Invalid date");m=String(s.masks[m]||m||s.masks.default);var v=m.slice(0,4);(v==="UTC:"||v==="GMT:")&&(m=m.slice(4),_=!0,v==="GMT:"&&(p=!0));var O=e(function(){return _?"getUTC":"get"},"_2"),M=e(function(){return n[O()+"Date"]()},"d"),T=e(function(){return n[O()+"Day"]()},"D2"),y=e(function(){return n[O()+"Month"]()},"m"),E=e(function(){return n[O()+"FullYear"]()},"y2"),w=e(function(){return n[O()+"Hours"]()},"H"),D=e(function(){return n[O()+"Minutes"]()},"M"),B=e(function(){return n[O()+"Seconds"]()},"s"),k=e(function(){return n[O()+"Milliseconds"]()},"L"),j=e(function(){return _?0:n.getTimezoneOffset()},"o"),W=e(function(){return h(n)},"W"),$=e(function(){return g(n)},"N"),V={d:e(function(){return M()},"d"),dd:e(function(){return u(M())},"dd"),ddd:e(function(){return s.i18n.dayNames[T()]},"ddd"),DDD:e(function(){return l({y:E(),m:y(),d:M(),_:O(),dayName:s.i18n.dayNames[T()],short:!0})},"DDD"),dddd:e(function(){return s.i18n.dayNames[T()+7]},"dddd"),DDDD:e(function(){return l({y:E(),m:y(),d:M(),_:O(),dayName:s.i18n.dayNames[T()+7]})},"DDDD"),m:e(function(){return y()+1},"m"),mm:e(function(){return u(y()+1)},"mm"),mmm:e(function(){return s.i18n.monthNames[y()]},"mmm"),mmmm:e(function(){return s.i18n.monthNames[y()+12]},"mmmm"),yy:e(function(){return String(E()).slice(2)},"yy"),yyyy:e(function(){return u(E(),4)},"yyyy"),h:e(function(){return w()%12||12},"h"),hh:e(function(){return u(w()%12||12)},"hh"),H:e(function(){return w()},"H"),HH:e(function(){return u(w())},"HH"),M:e(function(){return D()},"M"),MM:e(function(){return u(D())},"MM"),s:e(function(){return B()},"s"),ss:e(function(){return u(B())},"ss"),l:e(function(){return u(k(),3)},"l"),L:e(function(){return u(Math.floor(k()/10))},"L"),t:e(function(){return w()<12?s.i18n.timeNames[0]:s.i18n.timeNames[1]},"t"),tt:e(function(){return w()<12?s.i18n.timeNames[2]:s.i18n.timeNames[3]},"tt"),T:e(function(){return w()<12?s.i18n.timeNames[4]:s.i18n.timeNames[5]},"T"),TT:e(function(){return w()<12?s.i18n.timeNames[6]:s.i18n.timeNames[7]},"TT"),Z:e(function(){return p?"GMT":_?"UTC":(String(n).match(f)||[""]).pop().replace(S,"").replace(/GMT\+0000/g,"UTC")},"Z"),o:e(function(){return(j()>0?"-":"+")+u(Math.floor(Math.abs(j())/60)*100+Math.abs(j())%60,4)},"o"),p:e(function(){return(j()>0?"-":"+")+u(Math.floor(Math.abs(j())/60),2)+":"+u(Math.floor(Math.abs(j())%60),2)},"p"),S:e(function(){return["th","st","nd","rd"][M()%10>3?0:(M()%100-M()%10!=10)*M()%10]},"S"),W:e(function(){return W()},"W"),WW:e(function(){return u(W())},"WW"),N:e(function(){return $()},"N")};return m.replace(L,function(b){return b in V?V[b]():b.slice(1,b.length-1)})}}();s.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",paddedShortDate:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},s.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"],timeNames:["a","p","am","pm","A","P","AM","PM"]};var u=e(function(f,S){for(f=String(f),S=S||2;f.length<S;)f="0"+f;return f},"pad2"),l=e(function(f){var S=f.y,n=f.m,m=f.d,_=f._,p=f.dayName,v=f.short,O=v===void 0?!1:v,M=new Date,T=new Date;T.setDate(T[_+"Date"]()-1);var y=new Date;y.setDate(y[_+"Date"]()+1);var E=e(function(){return M[_+"Date"]()},"today_d2"),w=e(function(){return M[_+"Month"]()},"today_m2"),D=e(function(){return M[_+"FullYear"]()},"today_y2"),B=e(function(){return T[_+"Date"]()},"yesterday_d2"),k=e(function(){return T[_+"Month"]()},"yesterday_m2"),j=e(function(){return T[_+"FullYear"]()},"yesterday_y2"),W=e(function(){return y[_+"Date"]()},"tomorrow_d2"),$=e(function(){return y[_+"Month"]()},"tomorrow_m2"),V=e(function(){return y[_+"FullYear"]()},"tomorrow_y2");return D()===S&&w()===n&&E()===m?O?"Tdy":"Today":j()===S&&k()===n&&B()===m?O?"Ysd":"Yesterday":V()===S&&$()===n&&W()===m?O?"Tmw":"Tomorrow":p},"getDayName2"),h=e(function(f){var S=new Date(f.getFullYear(),f.getMonth(),f.getDate());S.setDate(S.getDate()-(S.getDay()+6)%7+3);var n=new Date(S.getFullYear(),0,4);n.setDate(n.getDate()-(n.getDay()+6)%7+3);var m=S.getTimezoneOffset()-n.getTimezoneOffset();S.setHours(S.getHours()-m);var _=(S-n)/(864e5*7);return 1+Math.floor(_)},"getWeek2"),g=e(function(f){var S=f.getDay();return S===0&&(S=7),S},"getDayOfWeek2"),P=e(function(f){return f===null?"null":f===void 0?"undefined":o(f)!=="object"?o(f):Array.isArray(f)?"array":{}.toString.call(f).slice(8,-1).toLowerCase()},"kindOf2");typeof define=="function"&&define.amd?define(function(){return s}):(typeof t>"u"?"undefined":o(t))==="object"?r.exports=s:i.dateFormat=s}(void 0)}}),qe=I({"lib/utils/is-valid-date.js"(t,r){"use strict";r.exports=o;function o(i){return i instanceof Date&&!Number.isNaN(i.getTime())}e(o,"isValidDate")}}),Er=I({"lib/utils/create-date.js"(t,r){"use strict";r.exports=i;var o=qe();function i(c){let s=new Date(c);return o(s)||(s=new Date(+c)),s}e(i,"createDate")}}),vr=I({"lib/utils/format-time.js"(t,r){"use strict";r.exports=l;var{DATE_FORMAT:o,DATE_FORMAT_SIMPLE:i}=se(),c=hr(),s=Er(),u=qe();function l(h,g=!1){if(g===!1)return h;let P=s(h);if(!u(P))return h;if(g===!0)return c(P,i);let L=g.toUpperCase();if(L==="SYS:STANDARD")return c(P,o);let f=L.substr(0,4);return f==="SYS:"||f==="UTC:"?f==="UTC:"?c(P,g):c(P,g.slice(4)):c(P,`UTC:${g}`)}e(l,"formatTime")}}),Or=I({"lib/utils/prettify-time.js"(t,r){"use strict";r.exports=i;var o=vr();function i({log:c,context:s}){let{timestampKey:u,translateTime:l}=s,h=s.customPrettifiers?.time,g=null;if(u in c?g=c[u]:"timestamp"in c&&(g=c.timestamp),g===null)return;let P=l?o(g,l):g;return h?h(P):`[${P}]`}e(i,"prettifyTime")}}),Lr=I({"node_modules/fast-copy/dist/cjs/index.cjs"(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Function.prototype.toString,o=Object.create,i=Object.prototype.toString,c=function(){function a(){this._keys=[],this._values=[]}return e(a,"LegacyCache2"),a.prototype.has=function(d){return!!~this._keys.indexOf(d)},a.prototype.get=function(d){return this._values[this._keys.indexOf(d)]},a.prototype.set=function(d,C){this._keys.push(d),this._values.push(C)},a}();function s(){return new c}e(s,"createCacheLegacy");function u(){return new WeakMap}e(u,"createCacheModern");var l=typeof WeakMap<"u"?u:s;function h(a){if(!a)return o(null);var d=a.constructor;if(d===Object)return a===Object.prototype?{}:o(a);if(~r.call(d).indexOf("[native code]"))try{return new d}catch{}return o(a)}e(h,"getCleanClone");function g(a){var d="";return a.global&&(d+="g"),a.ignoreCase&&(d+="i"),a.multiline&&(d+="m"),a.unicode&&(d+="u"),a.sticky&&(d+="y"),d}e(g,"getRegExpFlagsLegacy");function P(a){return a.flags}e(P,"getRegExpFlagsModern");var L=/test/g.flags==="g"?P:g;function f(a){var d=i.call(a);return d.substring(8,d.length-1)}e(f,"getTagLegacy");function S(a){return a[Symbol.toStringTag]||f(a)}e(S,"getTagModern");var n=typeof Symbol<"u"?S:f,m=Object.defineProperty,_=Object.getOwnPropertyDescriptor,p=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols,O=Object.prototype,M=O.hasOwnProperty,T=O.propertyIsEnumerable,y=typeof v=="function";function E(a){return p(a).concat(v(a))}e(E,"getStrictPropertiesModern");var w=y?E:p;function D(a,d,C){for(var R=w(a),F=0,U=R.length,A=void 0,N=void 0;F<U;++F)if(A=R[F],!(A==="callee"||A==="caller")){if(N=_(a,A),!N){d[A]=C.copier(a[A],C);continue}!N.get&&!N.set&&(N.value=C.copier(N.value,C));try{m(d,A,N)}catch{d[A]=N.value}}return d}e(D,"copyOwnPropertiesStrict");function B(a,d){var C=new d.Constructor;d.cache.set(a,C);for(var R=0,F=a.length;R<F;++R)C[R]=d.copier(a[R],d);return C}e(B,"copyArrayLoose");function k(a,d){var C=new d.Constructor;return d.cache.set(a,C),D(a,C,d)}e(k,"copyArrayStrict");function j(a,d){return a.slice(0)}e(j,"copyArrayBuffer");function W(a,d){return a.slice(0,a.size,a.type)}e(W,"copyBlob");function $(a,d){return new d.Constructor(j(a.buffer))}e($,"copyDataView");function V(a,d){return new d.Constructor(a.getTime())}e(V,"copyDate");function b(a,d){var C=new d.Constructor;return d.cache.set(a,C),a.forEach(function(R,F){C.set(F,d.copier(R,d))}),C}e(b,"copyMapLoose");function re(a,d){return D(a,b(a,d),d)}e(re,"copyMapStrict");function Y(a,d){var C=h(d.prototype);d.cache.set(a,C);for(var R in a)M.call(a,R)&&(C[R]=d.copier(a[R],d));return C}e(Y,"copyObjectLooseLegacy");function te(a,d){var C=h(d.prototype);d.cache.set(a,C);for(var R in a)M.call(a,R)&&(C[R]=d.copier(a[R],d));for(var F=v(a),U=0,A=F.length,N=void 0;U<A;++U)N=F[U],T.call(a,N)&&(C[N]=d.copier(a[N],d));return C}e(te,"copyObjectLooseModern");var ce=y?te:Y;function H(a,d){var C=h(d.prototype);return d.cache.set(a,C),D(a,C,d)}e(H,"copyObjectStrict");function Z(a,d){return new d.Constructor(a.valueOf())}e(Z,"copyPrimitiveWrapper");function Oe(a,d){var C=new d.Constructor(a.source,L(a));return C.lastIndex=a.lastIndex,C}e(Oe,"copyRegExp");function J(a,d){return a}e(J,"copySelf");function le(a,d){var C=new d.Constructor;return d.cache.set(a,C),a.forEach(function(R){C.add(d.copier(R,d))}),C}e(le,"copySetLoose");function Le(a,d){return D(a,le(a,d),d)}e(Le,"copySetStrict");var Se=Array.isArray,ne=Object.assign,be=Object.getPrototypeOf||function(a){return a.__proto__},fe={array:B,arrayBuffer:j,blob:W,dataView:$,date:V,error:J,map:b,object:ce,regExp:Oe,set:le},Te=ne({},fe,{array:k,map:re,object:H,set:Le});function Pe(a){return{Arguments:a.object,Array:a.array,ArrayBuffer:a.arrayBuffer,Blob:a.blob,Boolean:Z,DataView:a.dataView,Date:a.date,Error:a.error,Float32Array:a.arrayBuffer,Float64Array:a.arrayBuffer,Int8Array:a.arrayBuffer,Int16Array:a.arrayBuffer,Int32Array:a.arrayBuffer,Map:a.map,Number:Z,Object:a.object,Promise:J,RegExp:a.regExp,Set:a.set,String:Z,WeakMap:J,WeakSet:J,Uint8Array:a.arrayBuffer,Uint8ClampedArray:a.arrayBuffer,Uint16Array:a.arrayBuffer,Uint32Array:a.arrayBuffer,Uint64Array:a.arrayBuffer}}e(Pe,"getTagSpecificCopiers");function ie(a){var d=ne({},fe,a),C=Pe(d),R=C.Array,F=C.Object;function U(A,N){if(N.prototype=N.Constructor=void 0,!A||typeof A!="object")return A;if(N.cache.has(A))return N.cache.get(A);if(N.prototype=be(A),N.Constructor=N.prototype&&N.prototype.constructor,!N.Constructor||N.Constructor===Object)return F(A,N);if(Se(A))return R(A,N);var z=C[n(A)];return z?z(A,N):typeof A.then=="function"?A:F(A,N)}return e(U,"copier"),e(function(N){return U(N,{Constructor:void 0,cache:l(),copier:U,prototype:void 0})},"copy")}e(ie,"createCopier");function de(a){return ie(ne({},Te,a))}e(de,"createStrictCopier");var we=de({}),Me=ie({});t.copyStrict=we,t.createCopier=ie,t.createStrictCopier=de,t.default=Me}}),Sr=I({"lib/utils/delete-log-property.js"(t,r){"use strict";r.exports=c;var o=pe(),i=Ye();function c(s,u){let l=i(u),h=l.pop();s=o(s,l),s!==null&&typeof s=="object"&&Object.prototype.hasOwnProperty.call(s,h)&&delete s[h]}e(c,"deleteLogProperty")}}),br=I({"lib/utils/filter-log.js"(t,r){"use strict";r.exports=s;var{createCopier:o}=Lr(),i=o({}),c=Sr();function s({log:u,context:l}){let{ignoreKeys:h,includeKeys:g}=l,P=i(u);if(g){let L={};return g.forEach(f=>{L[f]=P[f]}),L}return h.forEach(L=>{c(P,L)}),P}e(s,"filterLog")}}),Tr=I({"lib/pretty.js"(t,r){r.exports=m;var o=lr(),i=Ve(),c=pr(),s=yr(),u=gr(),l=_r(),h=Ke(),g=Or(),P=br(),{LEVELS:L,LEVEL_KEY:f,LEVEL_NAMES:S}=se(),n=e(_=>{try{return{value:o.parse(_,{protoAction:"remove"})}}catch(p){return{err:p}}},"jsonParser");function m(_){let p;if(i(_))p=_;else{let E=n(_);if(E.err||!i(E.value))return _+this.EOL;p=E.value}if(this.minimumLevel){let E;this.useOnlyCustomProps?E=this.customLevels:E=this.customLevelNames[this.minimumLevel]!==void 0;let w;if(E?w=this.customLevelNames[this.minimumLevel]:w=S[this.minimumLevel],w||(w=typeof this.minimumLevel=="string"?S[this.minimumLevel]:S[L[this.minimumLevel].toLowerCase()]),p[this.levelKey===void 0?f:this.levelKey]<w)return}let v=u({log:p,context:this.context});(this.ignoreKeys||this.includeKeys)&&(p=P({log:p,context:this.context}));let O=s({log:p,context:{...this.context,...this.context.customProperties}}),M=l({log:p,context:this.context}),T=g({log:p,context:this.context}),y="";if(this.levelFirst&&O&&(y=`${O}`),T&&y===""?y=`${T}`:T&&(y=`${y} ${T}`),!this.levelFirst&&O&&(y.length>0?y=`${y} ${O}`:y=O),M&&(y.length>0?y=`${y} ${M}:`:y=M),y.endsWith(":")===!1&&y!==""&&(y+=":"),v!==void 0&&(y.length>0?y=`${y} ${v}`:y=v),y.length>0&&!this.singleLine&&(y+=this.EOL),p.type==="Error"&&p.stack){let E=c({log:p,context:this.context});this.singleLine&&(y+=this.EOL),y+=E}else if(this.hideObject===!1){let E=[this.messageKey,this.levelKey,this.timestampKey].filter(D=>typeof p[D]=="string"||typeof p[D]=="number"||typeof p[D]=="boolean"),w=h({log:p,skipKeys:E,context:this.context});this.singleLine&&!/^\s$/.test(w)&&(y+=" "),y+=w}return y}e(m,"pretty")}}),Ze=Tr();var Pr=Object.getOwnPropertyNames;var X=e((t,r)=>e(function(){return r||(0,t[Pr(t)[0]])((r={exports:{}}).exports,r),r.exports},"__require2"),"__commonJS"),He=X({"lib/constants.js"(t,r){"use strict";r.exports={DATE_FORMAT:"yyyy-mm-dd HH:MM:ss.l o",DATE_FORMAT_SIMPLE:"HH:MM:ss.l",ERROR_LIKE_KEYS:["err","error"],MESSAGE_KEY:"msg",LEVEL_KEY:"level",LEVEL_LABEL:"levelLabel",TIMESTAMP_KEY:"time",LEVELS:{default:"USERLVL",60:"FATAL",50:"ERROR",40:"WARN",30:"INFO",20:"DEBUG",10:"TRACE"},LEVEL_NAMES:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},LOGGER_KEYS:["pid","hostname","name","level","time","timestamp","caller"]}}}),wr=X({"node_modules/colorette/index.cjs"(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var{env:r={},argv:o=[],platform:i=""}=typeof process>"u"?{}:process,c="NO_COLOR"in r||o.includes("--no-color"),s="FORCE_COLOR"in r||o.includes("--color"),u=i==="win32",l=r.TERM==="dumb",h=globalThis.Deno&&globalThis.Deno.isatty(1)&&r.TERM&&!l,g="CI"in r&&("GITHUB_ACTIONS"in r||"GITLAB_CI"in r||"CIRCLECI"in r),P=!c&&(s||u&&!l||h||g),L=e((U,A,N,z,K=A.substring(0,U)+z,De=A.substring(U+N.length),$e=De.indexOf(N))=>K+($e<0?De:L($e,De,N,z)),"replaceClose"),f=e((U,A,N,z,K)=>U<0?N+A+z:N+L(U,A,z,K)+z,"clearBleed"),S=e((U,A,N=U,z=U.length+1)=>K=>K||!(K===""||K===void 0)?f((""+K).indexOf(A,z),K,U,A,N):"","filterEmpty"),n=e((U,A,N)=>S(`\x1B[${U}m`,`\x1B[${A}m`,N),"init"),m={reset:n(0,0),bold:n(1,22,"\x1B[22m\x1B[1m"),dim:n(2,22,"\x1B[22m\x1B[2m"),italic:n(3,23),underline:n(4,24),inverse:n(7,27),hidden:n(8,28),strikethrough:n(9,29),black:n(30,39),red:n(31,39),green:n(32,39),yellow:n(33,39),blue:n(34,39),magenta:n(35,39),cyan:n(36,39),white:n(37,39),gray:n(90,39),bgBlack:n(40,49),bgRed:n(41,49),bgGreen:n(42,49),bgYellow:n(43,49),bgBlue:n(44,49),bgMagenta:n(45,49),bgCyan:n(46,49),bgWhite:n(47,49),blackBright:n(90,39),redBright:n(91,39),greenBright:n(92,39),yellowBright:n(93,39),blueBright:n(94,39),magentaBright:n(95,39),cyanBright:n(96,39),whiteBright:n(97,39),bgBlackBright:n(100,49),bgRedBright:n(101,49),bgGreenBright:n(102,49),bgYellowBright:n(103,49),bgBlueBright:n(104,49),bgMagentaBright:n(105,49),bgCyanBright:n(106,49),bgWhiteBright:n(107,49)},_=e(({useColor:U=P}={})=>U?m:Object.keys(m).reduce((A,N)=>({...A,[N]:String}),{}),"createColors"),{reset:p,bold:v,dim:O,italic:M,underline:T,inverse:y,hidden:E,strikethrough:w,black:D,red:B,green:k,yellow:j,blue:W,magenta:$,cyan:V,white:b,gray:re,bgBlack:Y,bgRed:te,bgGreen:ce,bgYellow:H,bgBlue:Z,bgMagenta:Oe,bgCyan:J,bgWhite:le,blackBright:Le,redBright:Se,greenBright:ne,yellowBright:be,blueBright:fe,magentaBright:Te,cyanBright:Pe,whiteBright:ie,bgBlackBright:de,bgRedBright:we,bgGreenBright:Me,bgYellowBright:a,bgBlueBright:d,bgMagentaBright:C,bgCyanBright:R,bgWhiteBright:F}=_();t.bgBlack=Y,t.bgBlackBright=de,t.bgBlue=Z,t.bgBlueBright=d,t.bgCyan=J,t.bgCyanBright=R,t.bgGreen=ce,t.bgGreenBright=Me,t.bgMagenta=Oe,t.bgMagentaBright=C,t.bgRed=te,t.bgRedBright=we,t.bgWhite=le,t.bgWhiteBright=F,t.bgYellow=H,t.bgYellowBright=a,t.black=D,t.blackBright=Le,t.blue=W,t.blueBright=fe,t.bold=v,t.createColors=_,t.cyan=V,t.cyanBright=Pe,t.dim=O,t.gray=re,t.green=k,t.greenBright=ne,t.hidden=E,t.inverse=y,t.isColorSupported=P,t.italic=M,t.magenta=$,t.magentaBright=Te,t.red=B,t.redBright=Se,t.reset=p,t.strikethrough=w,t.underline=T,t.white=b,t.whiteBright=ie,t.yellow=j,t.yellowBright=be}}),Mr=X({"lib/colors.js"(t,r){"use strict";var{LEVELS:o,LEVEL_NAMES:i}=He(),c=e(y=>y,"nocolor"),s={default:c,60:c,50:c,40:c,30:c,20:c,10:c,message:c,greyMessage:c},{createColors:u}=wr(),l=u({useColor:!0}),{white:h,bgRed:g,red:P,yellow:L,green:f,blue:S,gray:n,cyan:m}=l,_={default:h,60:g,50:P,40:L,30:f,20:S,10:n,message:m,greyMessage:n};function p(y){return y.reduce(function(E,[w,D]){return E[w]=typeof l[D]=="function"?l[D]:h,E},{default:h,message:m,greyMessage:n})}e(p,"resolveCustomColoredColorizer");function v(y){return function(E,w,{customLevels:D,customLevelNames:B}={}){let k=y?D||o:Object.assign({},o,D),j=y?B||i:Object.assign({},i,B),W="default";Number.isInteger(+E)?W=Object.prototype.hasOwnProperty.call(k,E)?E:W:W=Object.prototype.hasOwnProperty.call(j,E.toLowerCase())?j[E.toLowerCase()]:W;let $=k[W];return Object.prototype.hasOwnProperty.call(w,W)?w[W]($):w.default($)}}e(v,"colorizeLevel");function O(y){let E=v(y),w=e(function(D,B){return E(D,s,B)},"customColoredColorizer");return w.message=s.message,w.greyMessage=s.greyMessage,w}e(O,"plainColorizer");function M(y){let E=v(y),w=e(function(D,B){return E(D,_,B)},"customColoredColorizer");return w.message=_.message,w.greyMessage=_.greyMessage,w}e(M,"coloredColorizer");function T(y,E){let w=p(y),D=E?w:Object.assign({},_,w),B=v(E),k=e(function(j,W){return B(j,D,W)},"customColoredColorizer");return k.message=k.message||D.message,k.greyMessage=k.greyMessage||D.greyMessage,k}e(T,"customColoredColorizerFactory"),r.exports=e(function(E=!1,w,D){return E&&w!==void 0?T(w,D):E?M(D):O(D)},"getColorizer")}}),Dr=X({"lib/utils/handle-custom-levels-opts.js"(t,r){"use strict";r.exports=o;function o(i){return i?typeof i=="string"?i.split(",").reduce((c,s,u)=>{let[l,h=u]=s.split(":");return c[h]=l.toUpperCase(),c},{default:"USERLVL"}):Object.prototype.toString.call(i)==="[object Object]"?Object.keys(i).reduce((c,s)=>(c[i[s]]=s.toUpperCase(),c),{default:"USERLVL"}):{}:{}}e(o,"handleCustomLevelsOpts")}}),Cr=X({"lib/utils/handle-custom-levels-names-opts.js"(t,r){"use strict";r.exports=o;function o(i){return i?typeof i=="string"?i.split(",").reduce((c,s,u)=>{let[l,h=u]=s.split(":");return c[l.toLowerCase()]=h,c},{}):Object.prototype.toString.call(i)==="[object Object]"?Object.keys(i).reduce((c,s)=>(c[s.toLowerCase()]=i[s],c),{}):{}:{}}e(o,"handleCustomLevelsNamesOpts")}}),Nr=X({"lib/utils/parse-factory-options.js"(t,r){r.exports=u;var{LEVEL_NAMES:o}=He(),i=Mr(),c=Dr(),s=Cr();function u(l){let h=l.crlf?`\r
`:`
`,g="    ",{customPrettifiers:P,errorLikeObjectKeys:L,hideObject:f,levelFirst:S,levelKey:n,levelLabel:m,messageFormat:_,messageKey:p,minimumLevel:v,singleLine:O,timestampKey:M,translateTime:T}=l,y=l.errorProps.split(","),E=typeof l.useOnlyCustomProps=="boolean"?l.useOnlyCustomProps:l.useOnlyCustomProps==="true",w=c(l.customLevels),D=s(l.customLevels),B;l.customColors&&(B=l.customColors.split(",").reduce((b,re)=>{let[Y,te]=re.split(":"),H=(E?l.customLevels:D[Y]!==void 0)?D[Y]:o[Y],Z=H!==void 0?H:Y;return b.push([Z,te]),b},[]));let k={customLevels:w,customLevelNames:D};E===!0&&!l.customLevels&&(k.customLevels=void 0,k.customLevelNames=void 0);let j=l.include!==void 0?new Set(l.include.split(",")):void 0,W=!j&&l.ignore?new Set(l.ignore.split(",")):void 0,$=i(l.colorize,B,E),V=l.colorizeObjects?$:i(!1,[],!1);return{EOL:h,IDENT:g,colorizer:$,customColors:B,customLevelNames:D,customLevels:w,customPrettifiers:P,customProperties:k,errorLikeObjectKeys:L,errorProps:y,hideObject:f,ignoreKeys:W,includeKeys:j,levelFirst:S,levelKey:n,levelLabel:m,messageFormat:_,messageKey:p,minimumLevel:v,objectColorizer:V,singleLine:O,timestampKey:M,translateTime:T,useOnlyCustomProps:E}}e(u,"parseFactoryOptions")}}),Je=Nr();var Ar={colorize:!0,colorizeObjects:!0,crlf:!1,customColors:null,customLevels:null,customPrettifiers:{},errorLikeObjectKeys:["err","error"],errorProps:"",hideObject:!1,ignore:"hostname",include:void 0,levelFirst:!1,levelKey:"level",levelLabel:"levelLabel",messageFormat:null,messageKey:"msg",minimumLevel:void 0,outputStream:console,singleLine:!1,timestampKey:"timestamp",translateTime:"SYS:HH:MM:ss",useOnlyCustomProps:!0};function Rr(t){let r=Je(Object.assign({},Ar,t));return Ze.bind({...r,context:r})}e(Rr,"prettyFactory");var Xe=Rr({customPrettifiers:{time:t=>`${t}`}}),ye=class extends x.handlers.BaseHandler{static{e(this,"ConsoleHandler")}format(r){try{let o=JSON.parse(r.msg),i=r.levelName;return r.levelName==="WARNING"&&(i="WARN"),o.level=i,o.timestamp||(o.timestamp=r.datetime),typeof o.timestamp=="object"&&o.timestamp!==null&&(o.timestamp=r.datetime),delete o.hostname,Xe(o)}catch{let i=r.levelName;return r.levelName==="WARNING"&&(i="WARN"),Xe({level:i,timestamp:r.datetime,msg:r.msg})}}log(r){console.log(r)}};function Ae(t){let r={type:"https://httpproblems.com/http-status/500",title:"Internal Server Error",status:500,detail:"Your Zuplo API Gateway ran into build errors. Address them and try again."},o=t.headers.get("zuplo-last-unhandled-error");return o&&(r.detail=`Your Zuplo API Gateway ran into a runtime error: ${o}.`),new Response(JSON.stringify(r,null,2),{status:500,headers:{"Content-Type":"application/json"}})}e(Ae,"handleInvalidBuild");var Qe="dist",er="worker.js",Re="zup.js",rr="env-vars.js";async function xe(t){let r=Object.fromEntries(t.headers.entries()),o=await t.arrayBuffer(),i=t.url;return r["zuplo-forwarded-host"]&&(i=t.url.replace(r.host,r["zuplo-forwarded-host"]),i=i.replace(/^http:/,"https:")),{url:i,body:o,cache:t.cache,credentials:t.credentials,headers:r,integrity:t.integrity,keepalive:t.keepalive,method:t.method,mode:t.mode,redirect:t.redirect,referrer:t.referrer,referrerPolicy:t.referrerPolicy,window:null}}e(xe,"serialize");function Ie(t){let r={headers:t.headers,status:t.status,statusText:t.statusText};return t.status==101||t.status==204||t.status==205||t.status==304?new Response(null,r):new Response(t.body,r)}e(Ie,"deserialize");var tr="worker.js";var Ue=class{static{e(this,"Settings")}get ZUPLO_GCP_BUNDLE_BUCKET_NAME(){return Deno.env.get("ZUPLO_GCP_BUNDLE_BUCKET_NAME")}get ZUPLO_GCP_BUNDLE_BUCKET_PATH(){return G.join(this.DEPLOYMENT_NAME??"",this.ZUPLO_DEPLOYMENT_SECRET??"",tr)}get ZUPLO_ACCOUNT_NAME(){return Deno.env.get("ZUPLO_ACCOUNT_NAME")}get ZUPLO_PROJECT_NAME(){return Deno.env.get("ZUPLO_PROJECT_NAME")}get DEPLOYMENT_NAME(){return Deno.env.get("DEPLOYMENT_NAME")}get ZUPLO_GCP_CLOUD_STORAGE_KEY(){return Deno.env.get("ZUPLO_GCP_CLOUD_STORAGE_KEY")}get ZUPLO_DEPLOYMENT_SECRET(){return Deno.env.get("ZUPLO_DEPLOYMENT_SECRET")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get SHOULD_LOAD_ENV_VARS(){return!!(ae.ZUPLO_ACCOUNT_NAME&&ae.ZUPLO_PROJECT_NAME&&ae.MANAGEMENT_API_URL&&ae.ZUPLO_AUTH_API_JWT)}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get ZUPLO_AUTH_API_JWT(){return Deno.env.get("__ZUPLO_AUTH_API_JWT")}get MANAGEMENT_API_URL(){return Deno.env.get("MANAGEMENT_API_URL")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},ae=new Ue,nr=ae;async function Be(t,r){return await Deno.writeTextFile(t,r,{create:!0}),t}e(Be,"createEnvVarsFile");function ke(t,r,o,i,c){let s=`import "${t}?version=${Date.now()}";`,u=o?`import "${o}";`:"",l=`import * as worker from "${i}?version=${Date.now()}";`,h=c?`import "${c}";`:"",g=["if (worker.default) {",'addEventListener("fetch", (event) => {',"  event.respondWith(worker.default.fetch(event.request, globalThis, event));","});","}"];return[s,[...r],u,l,h,...g].join(Deno.build.os==="windows"?q.EOL.CRLF:q.EOL.LF)}e(ke,"createExternallyLinkedZuploScript");function je(t){let r=Ur(t.isLocal),o=Br(t.env);return[r,o].join(Deno.build.os==="windows"?q.EOL.CRLF:q.EOL.LF)}e(je,"createVarsContent");var ir=["__ZUPLO_DEPLOYMENT_NAME","__ZUPLO_LOGGING_ID","__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","__ZUPLO_METRICS_API_URL","__ZUPLO_REMOTE_LOG_URL","__ZUPLO_REMOTE_LOG_TOKEN","__ZUPLO_ASSETS_CDN_URL","__ZUPLO_AUTH_API_JWT","__ZUPLO_EXTERNAL_SERVICES","MANAGEMENT_API_URL"],xr=ir.filter(t=>!["__ZUPLO_REMOTE_LOG_URL","__ZUPLO_METRICS_API_URL"].includes(t)),Ir=["__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","SYSTEM_LOG_LEVEL","PROJECT_ID","RUNTIME_ENV","LOGGING_ID","__ZUPLO_LOGGING_ID","GIT_SHA","MANAGEMENT_API_URL","__ZUPLO_MOCK_API_KEYS","__ZUPLO_AUTH_API_JWT"];function Ur(t){let r=Deno.env.toObject(),o=`//#region System Variables

`;if(t)for(let i of Ir)o+=`self['${i}'] = ${Q(r[i])};
`;else if(nr.IS_TEST)for(let i of xr)i==="__ZUPLO_DEPLOYMENT_NAME"?o+=`self['${i}'] = ${Q(r.DEPLOYMENT_NAME)};
`:o+=`self['${i}'] = \`${Q(r[i])}\`;
`;else for(let i of ir)i==="__ZUPLO_DEPLOYMENT_NAME"?o+=`self['${i}'] = ${Q(r.DEPLOYMENT_NAME)};
`:o+=`self['${i}'] = ${Q(r[i])};
`;return o+=`//#endregion

`,o}e(Ur,"_injectSystemVars");function Br(t){let r=`//#region Environment Variables

`;for(let[o,i]of t)r+=`self['${o}'] = ${Q(i)};
`;return r+=`//#endregion

`,r}e(Br,"_injectVars");function Q(t){return JSON.stringify(t)}e(Q,"_encodeAndEscapeAsNecessary");var me="OkMessage",ge="ErrorMessage",_e="WebSocketMessage";var he=class{static{e(this,"WebSocketHandler")}socket;clientSocket;constructor(r){r.onopen=o=>{x.info("socket onopen")},r.onmessage=o=>{x.info("socket onmessage"),this.getClientSocket().send(o.data)},r.onerror=o=>{x.info(`socket onerror: ${JSON.stringify(o)}`)},r.onclose=o=>{x.info("socket onclose"),this.getClientSocket().close()},this.socket=r}async setClientSocket(r){if(this.clientSocket)throw new Error("clientSocket is already set");r.onmessage=i=>{this.socket.send(i.data)},r.onclose=i=>{this.socket.close()};let o=0;for(;o<=3;)x.info(`Verifying if clientSocket is ready, state: ${r.readyState} `),r.readyState===WebSocket.OPEN?o=4:(o++,await new Promise(i=>setTimeout(i,o*500)));if(r.readyState!==WebSocket.OPEN)throw new Error("clientSocket connection cannot be established");this.clientSocket=r}getClientSocket(){if(!this.clientSocket)throw new Error("clientSocket is not available");return this.clientSocket}};var We=class{static{e(this,"Settings")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},kr=new We,Ee=kr;var ve=class{static{e(this,"LocalWorkerExecutor")}options;workerFilePath;workerContext;currentWorker;currentEnvVarsFilePath;pendingRequests=new Map;constructor(r){this.options=r,this.workerFilePath=G.toFileUrl(`${this.deriveModuleBasedir()}/${Re}`),this.workerContext={env:new Map,isLocal:!0}}initializeWorker(){this.currentWorker&&this.currentWorker.terminate(),delete this.currentWorker,this.currentWorker=new Worker(this.workerFilePath,{type:"module",deno:{permissions:{env:!1,ffi:!1,hrtime:!1,net:!0,read:!0,run:!1,write:!1}}}),this.currentWorker.postMessage({context:this.workerContext}),this.currentWorker.onmessage=r=>{try{if(r.data._type===me||r.data._type===ge||r.data._type===_e){let o=r.data._requestId;if(o){let i=this.pendingRequests.get(o);i&&i(r)}}else x.error(r)}catch(o){x.error("Unexpected error while responding to postMessage from worker",o)}}}preparePromise(r,o){return new Promise((c,s)=>{this.pendingRequests.set(r,async u=>{try{if(u.data._type===me){let l=Ie(u.data.response);c(l)}else if(u.data._type===ge)s(u.data.error);else if(u.data._type===_e&&o){let l=new WebSocket(u.data.websocket.url),{socket:h,response:g}=Deno.upgradeWebSocket(o);await new he(h).setClientSocket(l),c(g)}else x.error(u),s(u)}catch(l){x.error("Unexpected error while responding to postMessage from worker",l),s(l)}})})}deriveModuleBasedir(){return G.dirname(this.options.workerModulePath)}async writeWorkerScript(r){let o=import.meta.resolve("./worker-prologue.ts"),i=import.meta.resolve("./worker-epilogue.ts");this.currentEnvVarsFilePath=await Be(`${this.deriveModuleBasedir()}/${rr}`,je(r));let c=ke(G.toFileUrl(this.currentEnvVarsFilePath).toString(),this.linkPolyfills(r),o,G.toFileUrl(this.options.workerModulePath).toString(),i);Ee.IS_VERBOSE_DEBUG&&x.info(c);let s=`${this.deriveModuleBasedir()}/${Re}`;return await Deno.writeTextFile(s,c),new URL(`?version=${Date.now()}`,G.toFileUrl(s))}linkPolyfills(r){return[`import { URLPattern } from "${import.meta.resolve("../common-impl/polyfills/urlpattern-polyfill-6.0.2.js")}";`]}async init(){x.debug("Initializing local-executor"),await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),this.initializeWorker()}async initializeVars(){let r=new Map;if(q.existsSync(`${this.deriveModuleBasedir()}/../.env`)){let o=await Ce({envPath:`${this.deriveModuleBasedir()}/../.env`,examplePath:null,defaultsPath:null});for(let i in o)r.set(i,o[i])}if(q.existsSync(`${this.deriveModuleBasedir()}/../.env.zuplo`)){let o=await Ce({envPath:`${this.deriveModuleBasedir()}/../.env.zuplo`,examplePath:null,defaultsPath:null});for(let i in o)r.set(i,o[i])}for(let o in Deno.env.toObject())r.set(o,Deno.env.get(o));return Promise.resolve(r)}async initializeWorkerContents(){}async reloadScript(r){x.info("Reloading the contents of the zup locally");try{return await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),await this.initializeWorker(),new Response(null,{status:oe.Status.NoContent})}catch(o){return x.error("Unexpected error while responding to __/zuplo/reload",o),new Response(null,{status:oe.Status.InternalServerError})}}async execute(r){try{if(!this.currentWorker)return new Response(null,{status:oe.Status.ServiceUnavailable});let o=crypto.randomUUID();return this.currentWorker.postMessage({_requestId:o,request:await xe(r)}),this.preparePromise(o,r)}catch(o){return x.error("Unexpected error while trying to execute the current request in local-executor worker.",o),new Response(null,{status:oe.Status.InternalServerError})}}};var ue,or,ee="valid";async function sr(t){let r;t?.sourceDirectory?(r=t.sourceDirectory,x.debug(`Using passed in sourceDirectory of: ${r}`)):r=G.resolve(Deno.cwd());let o=G.join(r,Qe,er);ue=new ve({sourceDirectory:r,workerModulePath:o});let i=Ee.PROD_SERVER_PORT;t?.port&&(i=parseInt(t.port),x.debug(`Using passed in port of: ${t.port}`)),or=new Ge({port:i,handler:jr}),await or.listenAndServe()}e(sr,"start");async function ar(){await ue.init()}e(ar,"postStart");function jr(t){return ee==="valid"?t.url&&t.url.endsWith("__/zuplo/reload")?(ee="valid",ue.reloadScript(t)):t.url&&t.url.endsWith("__/zuplo/invalid-build")?(ee="invalid",Ae(t)):(ee="valid",ue.execute(t)):t.url&&t.url.endsWith("__/zuplo/reload")?(ee="valid",ue.reloadScript(t)):(ee="invalid",Ae(t))}e(jr,"handler");await x.setup({handlers:{console:new ye("DEBUG")},loggers:{default:{level:Deno.env.get("DENO_LOG_LEVEL")??"INFO",handlers:["console"]}}});var Fe=ze(Deno.args),Fr=sr({sourceDirectory:Fe.sourceDirectory,port:Fe.port,esm:!!Fe.esm}),$r=ar();await Promise.all([Fr,$r]);
