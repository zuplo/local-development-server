var ar=Object.defineProperty;var e=(n,r)=>ar(n,"name",{value:r,configurable:!0});import{bundle as Gr,transpile as qr}from"https://deno.land/x/emit@0.24.1/mod.ts";import{load as Fe}from"https://deno.land/std@0.195.0/dotenv/mod.ts";import{createOAuth2Token as Zr}from"https://deno.land/x/deno_gcp_admin@0.0.5/auth.ts";import{parse as We}from"https://deno.land/std@0.195.0/flags/mod.ts";import{Server as Ve}from"https://deno.land/std@0.195.0/http/server.ts";import*as ne from"https://deno.land/std@0.195.0/fs/mod.ts";import*as ie from"https://deno.land/std@0.195.0/http/http_status.ts";import*as x from"https://deno.land/std@0.195.0/log/mod.ts";import*as $ from"https://deno.land/std@0.195.0/path/mod.ts";import{assert as Qr,assertAlmostEquals as et,assertArrayIncludes as rt,assertEquals as tt,assertExists as nt,assertFalse as it,assertInstanceOf as ot,assertIsError as st,assertMatch as at,assertNotEquals as ut,assertNotMatch as ct,assertNotStrictEquals as lt,assertObjectMatch as ft,assertRejects as pt,assertStrictEquals as dt,assertStringIncludes as yt,assertThrows as mt,equal as gt,fail as _t,unimplemented as ht,unreachable as Et}from"https://deno.land/std@0.195.0/testing/asserts.ts";import{afterAll as Ot,afterEach as Lt,beforeAll as St,beforeEach as bt,describe as Tt,it as Pt}from"https://deno.land/std@0.195.0/testing/bdd.ts";var ur=Object.getOwnPropertyNames,I=e((n,r)=>e(function(){return r||(0,n[ur(n)[0]])((r={exports:{}}).exports,r),r.exports},"__require"),"__commonJS"),cr=I({"node_modules/secure-json-parse/index.js"(n,r){"use strict";var o=typeof Buffer<"u",i=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,u=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function s(g,P,L){L==null&&P!==null&&typeof P=="object"&&(L=P,P=void 0),o&&Buffer.isBuffer(g)&&(g=g.toString()),g&&g.charCodeAt(0)===65279&&(g=g.slice(1));let f=JSON.parse(g,P);if(f===null||typeof f!="object")return f;let S=L&&L.protoAction||"error",t=L&&L.constructorAction||"error";if(S==="ignore"&&t==="ignore")return f;if(S!=="ignore"&&t!=="ignore"){if(i.test(g)===!1&&u.test(g)===!1)return f}else if(S!=="ignore"&&t==="ignore"){if(i.test(g)===!1)return f}else if(u.test(g)===!1)return f;return c(f,{protoAction:S,constructorAction:t,safe:L&&L.safe})}e(s,"_parse");function c(g,{protoAction:P="error",constructorAction:L="error",safe:f}={}){let S=[g];for(;S.length;){let t=S;S=[];for(let m of t){if(P!=="ignore"&&Object.prototype.hasOwnProperty.call(m,"__proto__")){if(f===!0)return null;if(P==="error")throw new SyntaxError("Object contains forbidden prototype property");delete m.__proto__}if(L!=="ignore"&&Object.prototype.hasOwnProperty.call(m,"constructor")&&Object.prototype.hasOwnProperty.call(m.constructor,"prototype")){if(f===!0)return null;if(L==="error")throw new SyntaxError("Object contains forbidden prototype property");delete m.constructor}for(let _ in m){let d=m[_];d&&typeof d=="object"&&S.push(d)}}}return g}e(c,"filter");function l(g,P,L){let f=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(g,P,L)}finally{Error.stackTraceLimit=f}}e(l,"parse");function h(g,P){let L=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(g,P,{safe:!0})}catch{return null}finally{Error.stackTraceLimit=L}}e(h,"safeParse"),r.exports=l,r.exports.default=l,r.exports.parse=l,r.exports.safeParse=h,r.exports.scan=c}}),ze=I({"lib/utils/is-object.js"(n,r){"use strict";r.exports=o;function o(i){return Object.prototype.toString.apply(i)==="[object Object]"}e(o,"isObject")}}),oe=I({"lib/constants.js"(n,r){"use strict";r.exports={DATE_FORMAT:"yyyy-mm-dd HH:MM:ss.l o",DATE_FORMAT_SIMPLE:"HH:MM:ss.l",ERROR_LIKE_KEYS:["err","error"],MESSAGE_KEY:"msg",LEVEL_KEY:"level",LEVEL_LABEL:"levelLabel",TIMESTAMP_KEY:"time",LEVELS:{default:"USERLVL",60:"FATAL",50:"ERROR",40:"WARN",30:"INFO",20:"DEBUG",10:"TRACE"},LEVEL_NAMES:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},LOGGER_KEYS:["pid","hostname","name","level","time","timestamp","caller"]}}}),De=I({"lib/utils/join-lines-with-indentation.js"(n,r){"use strict";r.exports=o;function o({input:i,ident:u="    ",eol:s=`
`}){let c=i.split(/\r?\n/);for(let l=1;l<c.length;l+=1)c[l]=u+c[l];return c.join(s)}e(o,"joinLinesWithIndentation")}}),lr=I({"node_modules/fast-safe-stringify/index.js"(n,r){r.exports=l,l.default=l,l.stable=L,l.stableStringify=L;var o="[...]",i="[Circular]",u=[],s=[];function c(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}e(c,"defaultOptions");function l(t,m,_,d){typeof d>"u"&&(d=c()),g(t,"",0,[],void 0,0,d);var v;try{s.length===0?v=JSON.stringify(t,m,_):v=JSON.stringify(t,S(m),_)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;u.length!==0;){var O=u.pop();O.length===4?Object.defineProperty(O[0],O[1],O[3]):O[0][O[1]]=O[2]}}return v}e(l,"stringify");function h(t,m,_,d){var v=Object.getOwnPropertyDescriptor(d,_);v.get!==void 0?v.configurable?(Object.defineProperty(d,_,{value:t}),u.push([d,_,m,v])):s.push([m,_,t]):(d[_]=t,u.push([d,_,m]))}e(h,"setReplace");function g(t,m,_,d,v,O,M){O+=1;var T;if(typeof t=="object"&&t!==null){for(T=0;T<d.length;T++)if(d[T]===t){h(i,t,m,v);return}if(typeof M.depthLimit<"u"&&O>M.depthLimit){h(o,t,m,v);return}if(typeof M.edgesLimit<"u"&&_+1>M.edgesLimit){h(o,t,m,v);return}if(d.push(t),Array.isArray(t))for(T=0;T<t.length;T++)g(t[T],T,T,d,t,O,M);else{var y=Object.keys(t);for(T=0;T<y.length;T++){var E=y[T];g(t[E],E,T,d,t,O,M)}}d.pop()}}e(g,"decirc");function P(t,m){return t<m?-1:t>m?1:0}e(P,"compareFunction");function L(t,m,_,d){typeof d>"u"&&(d=c());var v=f(t,"",0,[],void 0,0,d)||t,O;try{s.length===0?O=JSON.stringify(v,m,_):O=JSON.stringify(v,S(m),_)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;u.length!==0;){var M=u.pop();M.length===4?Object.defineProperty(M[0],M[1],M[3]):M[0][M[1]]=M[2]}}return O}e(L,"deterministicStringify");function f(t,m,_,d,v,O,M){O+=1;var T;if(typeof t=="object"&&t!==null){for(T=0;T<d.length;T++)if(d[T]===t){h(i,t,m,v);return}try{if(typeof t.toJSON=="function")return}catch{return}if(typeof M.depthLimit<"u"&&O>M.depthLimit){h(o,t,m,v);return}if(typeof M.edgesLimit<"u"&&_+1>M.edgesLimit){h(o,t,m,v);return}if(d.push(t),Array.isArray(t))for(T=0;T<t.length;T++)f(t[T],T,T,d,t,O,M);else{var y={},E=Object.keys(t).sort(P);for(T=0;T<E.length;T++){var w=E[T];f(t[w],w,T,d,t,O,M),y[w]=t[w]}if(typeof v<"u")u.push([v,m,t]),v[m]=y;else return y}d.pop()}}e(f,"deterministicDecirc");function S(t){return t=typeof t<"u"?t:function(m,_){return _},function(m,_){if(s.length>0)for(var d=0;d<s.length;d++){var v=s[d];if(v[1]===m&&v[0]===_){_=v[2],s.splice(d,1);break}}return t.call(this,m,_)}}e(S,"replaceGetterValues")}}),fr=I({"lib/utils/prettify-error.js"(n,r){"use strict";r.exports=i;var o=De();function i({keyName:u,lines:s,eol:c,ident:l}){let h="",g=o({input:s,ident:l,eol:c}),P=`${l}${u}: ${g}${c}`.split(c);for(let L=0;L<P.length;L+=1){L!==0&&(h+=c);let f=P[L];if(/^\s*"stack"/.test(f)){let S=/^(\s*"stack":)\s*(".*"),?$/.exec(f);if(S&&S.length===3){let t=/^\s*/.exec(f)[0].length+4,m=" ".repeat(t),_=S[2];h+=S[1]+c+m+JSON.parse(_).replace(/\n/g,c+m)}else h+=f}else h+=f}return h}e(i,"prettifyError")}}),$e=I({"lib/utils/prettify-object.js"(n,r){"use strict";r.exports=c;var{LOGGER_KEYS:o}=oe(),i=lr(),u=De(),s=fr();function c({log:l,excludeLoggerKeys:h=!0,skipKeys:g=[],context:P}){let{EOL:L,IDENT:f,customPrettifiers:S,errorLikeObjectKeys:t,objectColorizer:m,singleLine:_}=P,d=[].concat(g);h===!0&&Array.prototype.push.apply(d,o);let v="",{plain:O,errors:M}=Object.entries(l).reduce(({plain:T,errors:y},[E,w])=>{if(d.includes(E)===!1){let D=typeof S[E]=="function"?S[E](w,E,l):w;t.includes(E)?y[E]=D:T[E]=D}return{plain:T,errors:y}},{plain:{},errors:{}});return _?(Object.keys(O).length>0&&(v+=m.greyMessage(i(O))),v+=L,v=v.replace(/\\\\/gi,"\\")):Object.entries(O).forEach(([T,y])=>{let E=typeof S[T]=="function"?y:i(y,null,2);if(E===void 0)return;E=E.replace(/\\\\/gi,"\\");let w=u({input:E,ident:f,eol:L});v+=`${f}${T}:${w.startsWith(L)?"":" "}${w}${L}`}),Object.entries(M).forEach(([T,y])=>{let E=typeof S[T]=="function"?y:i(y,null,2);E!==void 0&&(v+=s({keyName:T,lines:E,eol:L,ident:f}))}),v}e(c,"prettifyObject")}}),pr=I({"lib/utils/prettify-error-log.js"(n,r){"use strict";r.exports=c;var{LOGGER_KEYS:o}=oe(),i=ze(),u=De(),s=$e();function c({log:l,context:h}){let{EOL:g,IDENT:P,errorProps:L,messageKey:f}=h,S=l.stack,t=u({input:S,ident:P,eol:g}),m=`${P}${t}${g}`;if(L.length>0){let _=o.concat(f,"type","stack"),d;L[0]==="*"?d=Object.keys(l).filter(v=>_.includes(v)===!1):d=L.filter(v=>_.includes(v)===!1);for(let v=0;v<d.length;v+=1){let O=d[v];if(O in l){if(i(l[O])){let M=s({log:l[O],excludeLoggerKeys:!1,context:{...h,IDENT:P+P}});m=`${m}${P}${O}: {${g}${M}${P}}${g}`;continue}m=`${m}${P}${O}: ${l[O]}${g}`}}}return m}e(c,"prettifyErrorLog")}}),Ge=I({"lib/utils/split-property-key.js"(n,r){"use strict";r.exports=o;function o(i){let u=[],s=!1,c="";for(let l=0;l<i.length;l++){let h=i.charAt(l);if(h==="\\"){s=!0;continue}if(s){s=!1,c+=h;continue}if(h==="."){u.push(c),c="";continue}c+=h}return c.length&&u.push(c),u}e(o,"splitPropertyKey")}}),pe=I({"lib/utils/get-property-value.js"(n,r){"use strict";r.exports=i;var o=Ge();function i(u,s){let c=Array.isArray(s)?s:o(s);for(let l of c){if(!Object.prototype.hasOwnProperty.call(u,l))return;u=u[l]}return u}e(i,"getPropertyValue")}}),dr=I({"lib/utils/prettify-level.js"(n,r){"use strict";r.exports=i;var o=pe();function i({log:u,context:s}){let{colorizer:c,customLevels:l,customLevelNames:h,levelKey:g}=s,P=s.customPrettifiers?.level,L=o(u,g);if(L!==void 0)return P?P(L):c(L,{customLevels:l,customLevelNames:h})}e(i,"prettifyLevel")}}),yr=I({"lib/utils/interpret-conditionals.js"(n,r){"use strict";r.exports=i;var o=pe();function i(u,s){return u=u.replace(/{if (.*?)}(.*?){end}/g,c),u=u.replace(/{if (.*?)}/g,""),u=u.replace(/{end}/g,""),u.replace(/\s+/g," ").trim();function c(l,h,g){let P=o(s,h);return P&&g.includes(h)?g.replace(new RegExp("{"+h+"}","g"),P):""}e(c,"replacer")}e(i,"interpretConditionals")}}),mr=I({"lib/utils/prettify-message.js"(n,r){"use strict";r.exports=s;var{LEVELS:o}=oe(),i=pe(),u=yr();function s({log:c,context:l}){let{colorizer:h,customLevels:g,levelKey:P,levelLabel:L,messageFormat:f,messageKey:S,useOnlyCustomProps:t}=l;if(f&&typeof f=="string"){let m=u(f,c),_=String(m).replace(/{([^{}]+)}/g,function(d,v){let O;return v===L&&(O=i(c,P))!==void 0?(t?g===void 0:g[O]===void 0)?o[O]:g[O]:i(c,v)||""});return h.message(_)}if(f&&typeof f=="function"){let m=f(c,S,L);return h.message(m)}if(S in c&&!(typeof c[S]!="string"&&typeof c[S]!="number"&&typeof c[S]!="boolean"))return h.message(c[S])}e(s,"prettifyMessage")}}),gr=I({"lib/utils/prettify-metadata.js"(n,r){"use strict";r.exports=o;function o({log:i,context:u}){let s=u.customPrettifiers,c="";if(i.name||i.pid||i.hostname){if(c+="(",i.name&&(c+=s.name?s.name(i.name):i.name),i.pid){let l=s.pid?s.pid(i.pid):i.pid;i.name&&i.pid?c+="/"+l:c+=l}i.hostname&&(c+=`${c==="("?"on":" on"} ${s.hostname?s.hostname(i.hostname):i.hostname}`),c+=")"}if(i.caller&&(c+=`${c===""?"":" "}<${s.caller?s.caller(i.caller):i.caller}>`),c!=="")return c}e(o,"prettifyMetadata")}}),_r=I({"node_modules/dateformat/lib/dateformat.js"(n,r){"use strict";function o(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?o=e(function(s){return typeof s},"_typeof2"):o=e(function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},"_typeof2"),o(i)}e(o,"_typeof"),function(i){var u=arguments,s=function(){var L=/d{1,4}|D{3,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|W{1,2}|[LlopSZN]|"[^"]*"|'[^']*'/g,f=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,S=/[^-+\dA-Z]/g;return function(t,m,_,d){if(u.length===1&&P(t)==="string"&&!/\d/.test(t)&&(m=t,t=void 0),t=t||t===0?t:new Date,t instanceof Date||(t=new Date(t)),isNaN(t))throw TypeError("Invalid date");m=String(s.masks[m]||m||s.masks.default);var v=m.slice(0,4);(v==="UTC:"||v==="GMT:")&&(m=m.slice(4),_=!0,v==="GMT:"&&(d=!0));var O=e(function(){return _?"getUTC":"get"},"_2"),M=e(function(){return t[O()+"Date"]()},"d"),T=e(function(){return t[O()+"Day"]()},"D2"),y=e(function(){return t[O()+"Month"]()},"m"),E=e(function(){return t[O()+"FullYear"]()},"y2"),w=e(function(){return t[O()+"Hours"]()},"H"),D=e(function(){return t[O()+"Minutes"]()},"M"),B=e(function(){return t[O()+"Seconds"]()},"s"),k=e(function(){return t[O()+"Milliseconds"]()},"L"),j=e(function(){return _?0:t.getTimezoneOffset()},"o"),F=e(function(){return h(t)},"W"),V=e(function(){return g(t)},"N"),G={d:e(function(){return M()},"d"),dd:e(function(){return c(M())},"dd"),ddd:e(function(){return s.i18n.dayNames[T()]},"ddd"),DDD:e(function(){return l({y:E(),m:y(),d:M(),_:O(),dayName:s.i18n.dayNames[T()],short:!0})},"DDD"),dddd:e(function(){return s.i18n.dayNames[T()+7]},"dddd"),DDDD:e(function(){return l({y:E(),m:y(),d:M(),_:O(),dayName:s.i18n.dayNames[T()+7]})},"DDDD"),m:e(function(){return y()+1},"m"),mm:e(function(){return c(y()+1)},"mm"),mmm:e(function(){return s.i18n.monthNames[y()]},"mmm"),mmmm:e(function(){return s.i18n.monthNames[y()+12]},"mmmm"),yy:e(function(){return String(E()).slice(2)},"yy"),yyyy:e(function(){return c(E(),4)},"yyyy"),h:e(function(){return w()%12||12},"h"),hh:e(function(){return c(w()%12||12)},"hh"),H:e(function(){return w()},"H"),HH:e(function(){return c(w())},"HH"),M:e(function(){return D()},"M"),MM:e(function(){return c(D())},"MM"),s:e(function(){return B()},"s"),ss:e(function(){return c(B())},"ss"),l:e(function(){return c(k(),3)},"l"),L:e(function(){return c(Math.floor(k()/10))},"L"),t:e(function(){return w()<12?s.i18n.timeNames[0]:s.i18n.timeNames[1]},"t"),tt:e(function(){return w()<12?s.i18n.timeNames[2]:s.i18n.timeNames[3]},"tt"),T:e(function(){return w()<12?s.i18n.timeNames[4]:s.i18n.timeNames[5]},"T"),TT:e(function(){return w()<12?s.i18n.timeNames[6]:s.i18n.timeNames[7]},"TT"),Z:e(function(){return d?"GMT":_?"UTC":(String(t).match(f)||[""]).pop().replace(S,"").replace(/GMT\+0000/g,"UTC")},"Z"),o:e(function(){return(j()>0?"-":"+")+c(Math.floor(Math.abs(j())/60)*100+Math.abs(j())%60,4)},"o"),p:e(function(){return(j()>0?"-":"+")+c(Math.floor(Math.abs(j())/60),2)+":"+c(Math.floor(Math.abs(j())%60),2)},"p"),S:e(function(){return["th","st","nd","rd"][M()%10>3?0:(M()%100-M()%10!=10)*M()%10]},"S"),W:e(function(){return F()},"W"),WW:e(function(){return c(F())},"WW"),N:e(function(){return V()},"N")};return m.replace(L,function(b){return b in G?G[b]():b.slice(1,b.length-1)})}}();s.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",paddedShortDate:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},s.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"],timeNames:["a","p","am","pm","A","P","AM","PM"]};var c=e(function(f,S){for(f=String(f),S=S||2;f.length<S;)f="0"+f;return f},"pad2"),l=e(function(f){var S=f.y,t=f.m,m=f.d,_=f._,d=f.dayName,v=f.short,O=v===void 0?!1:v,M=new Date,T=new Date;T.setDate(T[_+"Date"]()-1);var y=new Date;y.setDate(y[_+"Date"]()+1);var E=e(function(){return M[_+"Date"]()},"today_d2"),w=e(function(){return M[_+"Month"]()},"today_m2"),D=e(function(){return M[_+"FullYear"]()},"today_y2"),B=e(function(){return T[_+"Date"]()},"yesterday_d2"),k=e(function(){return T[_+"Month"]()},"yesterday_m2"),j=e(function(){return T[_+"FullYear"]()},"yesterday_y2"),F=e(function(){return y[_+"Date"]()},"tomorrow_d2"),V=e(function(){return y[_+"Month"]()},"tomorrow_m2"),G=e(function(){return y[_+"FullYear"]()},"tomorrow_y2");return D()===S&&w()===t&&E()===m?O?"Tdy":"Today":j()===S&&k()===t&&B()===m?O?"Ysd":"Yesterday":G()===S&&V()===t&&F()===m?O?"Tmw":"Tomorrow":d},"getDayName2"),h=e(function(f){var S=new Date(f.getFullYear(),f.getMonth(),f.getDate());S.setDate(S.getDate()-(S.getDay()+6)%7+3);var t=new Date(S.getFullYear(),0,4);t.setDate(t.getDate()-(t.getDay()+6)%7+3);var m=S.getTimezoneOffset()-t.getTimezoneOffset();S.setHours(S.getHours()-m);var _=(S-t)/(864e5*7);return 1+Math.floor(_)},"getWeek2"),g=e(function(f){var S=f.getDay();return S===0&&(S=7),S},"getDayOfWeek2"),P=e(function(f){return f===null?"null":f===void 0?"undefined":o(f)!=="object"?o(f):Array.isArray(f)?"array":{}.toString.call(f).slice(8,-1).toLowerCase()},"kindOf2");typeof define=="function"&&define.amd?define(function(){return s}):(typeof n>"u"?"undefined":o(n))==="object"?r.exports=s:i.dateFormat=s}(void 0)}}),qe=I({"lib/utils/is-valid-date.js"(n,r){"use strict";r.exports=o;function o(i){return i instanceof Date&&!Number.isNaN(i.getTime())}e(o,"isValidDate")}}),hr=I({"lib/utils/create-date.js"(n,r){"use strict";r.exports=i;var o=qe();function i(u){let s=new Date(u);return o(s)||(s=new Date(+u)),s}e(i,"createDate")}}),Er=I({"lib/utils/format-time.js"(n,r){"use strict";r.exports=l;var{DATE_FORMAT:o,DATE_FORMAT_SIMPLE:i}=oe(),u=_r(),s=hr(),c=qe();function l(h,g=!1){if(g===!1)return h;let P=s(h);if(!c(P))return h;if(g===!0)return u(P,i);let L=g.toUpperCase();if(L==="SYS:STANDARD")return u(P,o);let f=L.substr(0,4);return f==="SYS:"||f==="UTC:"?f==="UTC:"?u(P,g):u(P,g.slice(4)):u(P,`UTC:${g}`)}e(l,"formatTime")}}),vr=I({"lib/utils/prettify-time.js"(n,r){"use strict";r.exports=i;var o=Er();function i({log:u,context:s}){let{timestampKey:c,translateTime:l}=s,h=s.customPrettifiers?.time,g=null;if(c in u?g=u[c]:"timestamp"in u&&(g=u.timestamp),g===null)return;let P=l?o(g,l):g;return h?h(P):`[${P}]`}e(i,"prettifyTime")}}),Or=I({"node_modules/fast-copy/dist/cjs/index.cjs"(n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=Function.prototype.toString,o=Object.create,i=Object.prototype.toString,u=function(){function a(){this._keys=[],this._values=[]}return e(a,"LegacyCache2"),a.prototype.has=function(p){return!!~this._keys.indexOf(p)},a.prototype.get=function(p){return this._values[this._keys.indexOf(p)]},a.prototype.set=function(p,C){this._keys.push(p),this._values.push(C)},a}();function s(){return new u}e(s,"createCacheLegacy");function c(){return new WeakMap}e(c,"createCacheModern");var l=typeof WeakMap<"u"?c:s;function h(a){if(!a)return o(null);var p=a.constructor;if(p===Object)return a===Object.prototype?{}:o(a);if(~r.call(p).indexOf("[native code]"))try{return new p}catch{}return o(a)}e(h,"getCleanClone");function g(a){var p="";return a.global&&(p+="g"),a.ignoreCase&&(p+="i"),a.multiline&&(p+="m"),a.unicode&&(p+="u"),a.sticky&&(p+="y"),p}e(g,"getRegExpFlagsLegacy");function P(a){return a.flags}e(P,"getRegExpFlagsModern");var L=/test/g.flags==="g"?P:g;function f(a){var p=i.call(a);return p.substring(8,p.length-1)}e(f,"getTagLegacy");function S(a){return a[Symbol.toStringTag]||f(a)}e(S,"getTagModern");var t=typeof Symbol<"u"?S:f,m=Object.defineProperty,_=Object.getOwnPropertyDescriptor,d=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols,O=Object.prototype,M=O.hasOwnProperty,T=O.propertyIsEnumerable,y=typeof v=="function";function E(a){return d(a).concat(v(a))}e(E,"getStrictPropertiesModern");var w=y?E:d;function D(a,p,C){for(var A=w(a),W=0,U=A.length,R=void 0,N=void 0;W<U;++W)if(R=A[W],!(R==="callee"||R==="caller")){if(N=_(a,R),!N){p[R]=C.copier(a[R],C);continue}!N.get&&!N.set&&(N.value=C.copier(N.value,C));try{m(p,R,N)}catch{p[R]=N.value}}return p}e(D,"copyOwnPropertiesStrict");function B(a,p){var C=new p.Constructor;p.cache.set(a,C);for(var A=0,W=a.length;A<W;++A)C[A]=p.copier(a[A],p);return C}e(B,"copyArrayLoose");function k(a,p){var C=new p.Constructor;return p.cache.set(a,C),D(a,C,p)}e(k,"copyArrayStrict");function j(a,p){return a.slice(0)}e(j,"copyArrayBuffer");function F(a,p){return a.slice(0,a.size,a.type)}e(F,"copyBlob");function V(a,p){return new p.Constructor(j(a.buffer))}e(V,"copyDataView");function G(a,p){return new p.Constructor(a.getTime())}e(G,"copyDate");function b(a,p){var C=new p.Constructor;return p.cache.set(a,C),a.forEach(function(A,W){C.set(W,p.copier(A,p))}),C}e(b,"copyMapLoose");function Q(a,p){return D(a,b(a,p),p)}e(Q,"copyMapStrict");function K(a,p){var C=h(p.prototype);p.cache.set(a,C);for(var A in a)M.call(a,A)&&(C[A]=p.copier(a[A],p));return C}e(K,"copyObjectLooseLegacy");function ee(a,p){var C=h(p.prototype);p.cache.set(a,C);for(var A in a)M.call(a,A)&&(C[A]=p.copier(a[A],p));for(var W=v(a),U=0,R=W.length,N=void 0;U<R;++U)N=W[U],T.call(a,N)&&(C[N]=p.copier(a[N],p));return C}e(ee,"copyObjectLooseModern");var ue=y?ee:K;function Z(a,p){var C=h(p.prototype);return p.cache.set(a,C),D(a,C,p)}e(Z,"copyObjectStrict");function Y(a,p){return new p.Constructor(a.valueOf())}e(Y,"copyPrimitiveWrapper");function ve(a,p){var C=new p.Constructor(a.source,L(a));return C.lastIndex=a.lastIndex,C}e(ve,"copyRegExp");function H(a,p){return a}e(H,"copySelf");function ce(a,p){var C=new p.Constructor;return p.cache.set(a,C),a.forEach(function(A){C.add(p.copier(A,p))}),C}e(ce,"copySetLoose");function Oe(a,p){return D(a,ce(a,p),p)}e(Oe,"copySetStrict");var Le=Array.isArray,re=Object.assign,Se=Object.getPrototypeOf||function(a){return a.__proto__},le={array:B,arrayBuffer:j,blob:F,dataView:V,date:G,error:H,map:b,object:ue,regExp:ve,set:ce},be=re({},le,{array:k,map:Q,object:Z,set:Oe});function Te(a){return{Arguments:a.object,Array:a.array,ArrayBuffer:a.arrayBuffer,Blob:a.blob,Boolean:Y,DataView:a.dataView,Date:a.date,Error:a.error,Float32Array:a.arrayBuffer,Float64Array:a.arrayBuffer,Int8Array:a.arrayBuffer,Int16Array:a.arrayBuffer,Int32Array:a.arrayBuffer,Map:a.map,Number:Y,Object:a.object,Promise:H,RegExp:a.regExp,Set:a.set,String:Y,WeakMap:H,WeakSet:H,Uint8Array:a.arrayBuffer,Uint8ClampedArray:a.arrayBuffer,Uint16Array:a.arrayBuffer,Uint32Array:a.arrayBuffer,Uint64Array:a.arrayBuffer}}e(Te,"getTagSpecificCopiers");function te(a){var p=re({},le,a),C=Te(p),A=C.Array,W=C.Object;function U(R,N){if(N.prototype=N.Constructor=void 0,!R||typeof R!="object")return R;if(N.cache.has(R))return N.cache.get(R);if(N.prototype=Se(R),N.Constructor=N.prototype&&N.prototype.constructor,!N.Constructor||N.Constructor===Object)return W(R,N);if(Le(R))return A(R,N);var z=C[t(R)];return z?z(R,N):typeof R.then=="function"?R:W(R,N)}return e(U,"copier"),e(function(N){return U(N,{Constructor:void 0,cache:l(),copier:U,prototype:void 0})},"copy")}e(te,"createCopier");function fe(a){return te(re({},be,a))}e(fe,"createStrictCopier");var Pe=fe({}),we=te({});n.copyStrict=Pe,n.createCopier=te,n.createStrictCopier=fe,n.default=we}}),Lr=I({"lib/utils/delete-log-property.js"(n,r){"use strict";r.exports=u;var o=pe(),i=Ge();function u(s,c){let l=i(c),h=l.pop();s=o(s,l),s!==null&&typeof s=="object"&&Object.prototype.hasOwnProperty.call(s,h)&&delete s[h]}e(u,"deleteLogProperty")}}),Sr=I({"lib/utils/filter-log.js"(n,r){"use strict";r.exports=s;var{createCopier:o}=Or(),i=o({}),u=Lr();function s({log:c,context:l}){let{ignoreKeys:h,includeKeys:g}=l,P=i(c);if(g){let L={};return g.forEach(f=>{L[f]=P[f]}),L}return h.forEach(L=>{u(P,L)}),P}e(s,"filterLog")}}),br=I({"lib/pretty.js"(n,r){r.exports=m;var o=cr(),i=ze(),u=pr(),s=dr(),c=mr(),l=gr(),h=$e(),g=vr(),P=Sr(),{LEVELS:L,LEVEL_KEY:f,LEVEL_NAMES:S}=oe(),t=e(_=>{try{return{value:o.parse(_,{protoAction:"remove"})}}catch(d){return{err:d}}},"jsonParser");function m(_){let d;if(i(_))d=_;else{let E=t(_);if(E.err||!i(E.value))return _+this.EOL;d=E.value}if(this.minimumLevel){let E;this.useOnlyCustomProps?E=this.customLevels:E=this.customLevelNames[this.minimumLevel]!==void 0;let w;if(E?w=this.customLevelNames[this.minimumLevel]:w=S[this.minimumLevel],w||(w=typeof this.minimumLevel=="string"?S[this.minimumLevel]:S[L[this.minimumLevel].toLowerCase()]),d[this.levelKey===void 0?f:this.levelKey]<w)return}let v=c({log:d,context:this.context});(this.ignoreKeys||this.includeKeys)&&(d=P({log:d,context:this.context}));let O=s({log:d,context:{...this.context,...this.context.customProperties}}),M=l({log:d,context:this.context}),T=g({log:d,context:this.context}),y="";if(this.levelFirst&&O&&(y=`${O}`),T&&y===""?y=`${T}`:T&&(y=`${y} ${T}`),!this.levelFirst&&O&&(y.length>0?y=`${y} ${O}`:y=O),M&&(y.length>0?y=`${y} ${M}:`:y=M),y.endsWith(":")===!1&&y!==""&&(y+=":"),v!==void 0&&(y.length>0?y=`${y} ${v}`:y=v),y.length>0&&!this.singleLine&&(y+=this.EOL),d.type==="Error"&&d.stack){let E=u({log:d,context:this.context});this.singleLine&&(y+=this.EOL),y+=E}else if(this.hideObject===!1){let E=[this.messageKey,this.levelKey,this.timestampKey].filter(D=>typeof d[D]=="string"||typeof d[D]=="number"||typeof d[D]=="boolean"),w=h({log:d,skipKeys:E,context:this.context});this.singleLine&&!/^\s$/.test(w)&&(y+=" "),y+=w}return y}e(m,"pretty")}}),Ke=br();var Tr=Object.getOwnPropertyNames;var J=e((n,r)=>e(function(){return r||(0,n[Tr(n)[0]])((r={exports:{}}).exports,r),r.exports},"__require2"),"__commonJS"),Ye=J({"lib/constants.js"(n,r){"use strict";r.exports={DATE_FORMAT:"yyyy-mm-dd HH:MM:ss.l o",DATE_FORMAT_SIMPLE:"HH:MM:ss.l",ERROR_LIKE_KEYS:["err","error"],MESSAGE_KEY:"msg",LEVEL_KEY:"level",LEVEL_LABEL:"levelLabel",TIMESTAMP_KEY:"time",LEVELS:{default:"USERLVL",60:"FATAL",50:"ERROR",40:"WARN",30:"INFO",20:"DEBUG",10:"TRACE"},LEVEL_NAMES:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},LOGGER_KEYS:["pid","hostname","name","level","time","timestamp","caller"]}}}),Pr=J({"node_modules/colorette/index.cjs"(n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var{env:r={},argv:o=[],platform:i=""}=typeof process>"u"?{}:process,u="NO_COLOR"in r||o.includes("--no-color"),s="FORCE_COLOR"in r||o.includes("--color"),c=i==="win32",l=r.TERM==="dumb",h=globalThis.Deno&&globalThis.Deno.isatty(1)&&r.TERM&&!l,g="CI"in r&&("GITHUB_ACTIONS"in r||"GITLAB_CI"in r||"CIRCLECI"in r),P=!u&&(s||c&&!l||h||g),L=e((U,R,N,z,q=R.substring(0,U)+z,Me=R.substring(U+N.length),je=Me.indexOf(N))=>q+(je<0?Me:L(je,Me,N,z)),"replaceClose"),f=e((U,R,N,z,q)=>U<0?N+R+z:N+L(U,R,z,q)+z,"clearBleed"),S=e((U,R,N=U,z=U.length+1)=>q=>q||!(q===""||q===void 0)?f((""+q).indexOf(R,z),q,U,R,N):"","filterEmpty"),t=e((U,R,N)=>S(`\x1B[${U}m`,`\x1B[${R}m`,N),"init"),m={reset:t(0,0),bold:t(1,22,"\x1B[22m\x1B[1m"),dim:t(2,22,"\x1B[22m\x1B[2m"),italic:t(3,23),underline:t(4,24),inverse:t(7,27),hidden:t(8,28),strikethrough:t(9,29),black:t(30,39),red:t(31,39),green:t(32,39),yellow:t(33,39),blue:t(34,39),magenta:t(35,39),cyan:t(36,39),white:t(37,39),gray:t(90,39),bgBlack:t(40,49),bgRed:t(41,49),bgGreen:t(42,49),bgYellow:t(43,49),bgBlue:t(44,49),bgMagenta:t(45,49),bgCyan:t(46,49),bgWhite:t(47,49),blackBright:t(90,39),redBright:t(91,39),greenBright:t(92,39),yellowBright:t(93,39),blueBright:t(94,39),magentaBright:t(95,39),cyanBright:t(96,39),whiteBright:t(97,39),bgBlackBright:t(100,49),bgRedBright:t(101,49),bgGreenBright:t(102,49),bgYellowBright:t(103,49),bgBlueBright:t(104,49),bgMagentaBright:t(105,49),bgCyanBright:t(106,49),bgWhiteBright:t(107,49)},_=e(({useColor:U=P}={})=>U?m:Object.keys(m).reduce((R,N)=>({...R,[N]:String}),{}),"createColors"),{reset:d,bold:v,dim:O,italic:M,underline:T,inverse:y,hidden:E,strikethrough:w,black:D,red:B,green:k,yellow:j,blue:F,magenta:V,cyan:G,white:b,gray:Q,bgBlack:K,bgRed:ee,bgGreen:ue,bgYellow:Z,bgBlue:Y,bgMagenta:ve,bgCyan:H,bgWhite:ce,blackBright:Oe,redBright:Le,greenBright:re,yellowBright:Se,blueBright:le,magentaBright:be,cyanBright:Te,whiteBright:te,bgBlackBright:fe,bgRedBright:Pe,bgGreenBright:we,bgYellowBright:a,bgBlueBright:p,bgMagentaBright:C,bgCyanBright:A,bgWhiteBright:W}=_();n.bgBlack=K,n.bgBlackBright=fe,n.bgBlue=Y,n.bgBlueBright=p,n.bgCyan=H,n.bgCyanBright=A,n.bgGreen=ue,n.bgGreenBright=we,n.bgMagenta=ve,n.bgMagentaBright=C,n.bgRed=ee,n.bgRedBright=Pe,n.bgWhite=ce,n.bgWhiteBright=W,n.bgYellow=Z,n.bgYellowBright=a,n.black=D,n.blackBright=Oe,n.blue=F,n.blueBright=le,n.bold=v,n.createColors=_,n.cyan=G,n.cyanBright=Te,n.dim=O,n.gray=Q,n.green=k,n.greenBright=re,n.hidden=E,n.inverse=y,n.isColorSupported=P,n.italic=M,n.magenta=V,n.magentaBright=be,n.red=B,n.redBright=Le,n.reset=d,n.strikethrough=w,n.underline=T,n.white=b,n.whiteBright=te,n.yellow=j,n.yellowBright=Se}}),wr=J({"lib/colors.js"(n,r){"use strict";var{LEVELS:o,LEVEL_NAMES:i}=Ye(),u=e(y=>y,"nocolor"),s={default:u,60:u,50:u,40:u,30:u,20:u,10:u,message:u,greyMessage:u},{createColors:c}=Pr(),l=c({useColor:!0}),{white:h,bgRed:g,red:P,yellow:L,green:f,blue:S,gray:t,cyan:m}=l,_={default:h,60:g,50:P,40:L,30:f,20:S,10:t,message:m,greyMessage:t};function d(y){return y.reduce(function(E,[w,D]){return E[w]=typeof l[D]=="function"?l[D]:h,E},{default:h,message:m,greyMessage:t})}e(d,"resolveCustomColoredColorizer");function v(y){return function(E,w,{customLevels:D,customLevelNames:B}={}){let k=y?D||o:Object.assign({},o,D),j=y?B||i:Object.assign({},i,B),F="default";Number.isInteger(+E)?F=Object.prototype.hasOwnProperty.call(k,E)?E:F:F=Object.prototype.hasOwnProperty.call(j,E.toLowerCase())?j[E.toLowerCase()]:F;let V=k[F];return Object.prototype.hasOwnProperty.call(w,F)?w[F](V):w.default(V)}}e(v,"colorizeLevel");function O(y){let E=v(y),w=e(function(D,B){return E(D,s,B)},"customColoredColorizer");return w.message=s.message,w.greyMessage=s.greyMessage,w}e(O,"plainColorizer");function M(y){let E=v(y),w=e(function(D,B){return E(D,_,B)},"customColoredColorizer");return w.message=_.message,w.greyMessage=_.greyMessage,w}e(M,"coloredColorizer");function T(y,E){let w=d(y),D=E?w:Object.assign({},_,w),B=v(E),k=e(function(j,F){return B(j,D,F)},"customColoredColorizer");return k.message=k.message||D.message,k.greyMessage=k.greyMessage||D.greyMessage,k}e(T,"customColoredColorizerFactory"),r.exports=e(function(E=!1,w,D){return E&&w!==void 0?T(w,D):E?M(D):O(D)},"getColorizer")}}),Mr=J({"lib/utils/handle-custom-levels-opts.js"(n,r){"use strict";r.exports=o;function o(i){return i?typeof i=="string"?i.split(",").reduce((u,s,c)=>{let[l,h=c]=s.split(":");return u[h]=l.toUpperCase(),u},{default:"USERLVL"}):Object.prototype.toString.call(i)==="[object Object]"?Object.keys(i).reduce((u,s)=>(u[i[s]]=s.toUpperCase(),u),{default:"USERLVL"}):{}:{}}e(o,"handleCustomLevelsOpts")}}),Dr=J({"lib/utils/handle-custom-levels-names-opts.js"(n,r){"use strict";r.exports=o;function o(i){return i?typeof i=="string"?i.split(",").reduce((u,s,c)=>{let[l,h=c]=s.split(":");return u[l.toLowerCase()]=h,u},{}):Object.prototype.toString.call(i)==="[object Object]"?Object.keys(i).reduce((u,s)=>(u[s.toLowerCase()]=i[s],u),{}):{}:{}}e(o,"handleCustomLevelsNamesOpts")}}),Cr=J({"lib/utils/parse-factory-options.js"(n,r){r.exports=c;var{LEVEL_NAMES:o}=Ye(),i=wr(),u=Mr(),s=Dr();function c(l){let h=l.crlf?`\r
`:`
`,g="    ",{customPrettifiers:P,errorLikeObjectKeys:L,hideObject:f,levelFirst:S,levelKey:t,levelLabel:m,messageFormat:_,messageKey:d,minimumLevel:v,singleLine:O,timestampKey:M,translateTime:T}=l,y=l.errorProps.split(","),E=typeof l.useOnlyCustomProps=="boolean"?l.useOnlyCustomProps:l.useOnlyCustomProps==="true",w=u(l.customLevels),D=s(l.customLevels),B;l.customColors&&(B=l.customColors.split(",").reduce((b,Q)=>{let[K,ee]=Q.split(":"),Z=(E?l.customLevels:D[K]!==void 0)?D[K]:o[K],Y=Z!==void 0?Z:K;return b.push([Y,ee]),b},[]));let k={customLevels:w,customLevelNames:D};E===!0&&!l.customLevels&&(k.customLevels=void 0,k.customLevelNames=void 0);let j=l.include!==void 0?new Set(l.include.split(",")):void 0,F=!j&&l.ignore?new Set(l.ignore.split(",")):void 0,V=i(l.colorize,B,E),G=l.colorizeObjects?V:i(!1,[],!1);return{EOL:h,IDENT:g,colorizer:V,customColors:B,customLevelNames:D,customLevels:w,customPrettifiers:P,customProperties:k,errorLikeObjectKeys:L,errorProps:y,hideObject:f,ignoreKeys:F,includeKeys:j,levelFirst:S,levelKey:t,levelLabel:m,messageFormat:_,messageKey:d,minimumLevel:v,objectColorizer:G,singleLine:O,timestampKey:M,translateTime:T,useOnlyCustomProps:E}}e(c,"parseFactoryOptions")}}),Ze=Cr();var Nr={colorize:!0,colorizeObjects:!0,crlf:!1,customColors:null,customLevels:null,customPrettifiers:{},errorLikeObjectKeys:["err","error"],errorProps:"",hideObject:!1,ignore:"hostname",include:void 0,levelFirst:!1,levelKey:"level",levelLabel:"levelLabel",messageFormat:null,messageKey:"msg",minimumLevel:void 0,outputStream:console,singleLine:!1,timestampKey:"timestamp",translateTime:"SYS:HH:MM:ss",useOnlyCustomProps:!0};function Rr(n){let r=Ze(Object.assign({},Nr,n));return Ke.bind({...r,context:r})}e(Rr,"prettyFactory");var He=Rr({customPrettifiers:{time:n=>`${n}`}}),de=class extends x.handlers.BaseHandler{static{e(this,"ConsoleHandler")}format(r){try{let o=JSON.parse(r.msg);return o.level=r.levelName,o.timestamp||(o.timestamp=r.datetime),delete o.hostname,He(o)}catch{return He({level:r.levelName,timestamp:r.datetime,msg:r.msg})}}log(r){console.log(r)}};var Ce="dist",Je="worker.js",Ne="zup.js",Xe="env-vars.js",Qe="worker-invalid-build.js";var Re=class{static{e(this,"Settings")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},Ar=new Re,ye=Ar;async function Ae(n){let r=Object.fromEntries(n.headers.entries()),o=await n.arrayBuffer(),i=n.url;return r["zuplo-forwarded-host"]&&(i=n.url.replace(r.host,r["zuplo-forwarded-host"]),i=i.replace(/^http:/,"https:")),{url:i,body:o,cache:n.cache,credentials:n.credentials,headers:r,integrity:n.integrity,keepalive:n.keepalive,method:n.method,mode:n.mode,redirect:n.redirect,referrer:n.referrer,referrerPolicy:n.referrerPolicy,window:null}}e(Ae,"serialize");function xe(n){let r={headers:n.headers,status:n.status,statusText:n.statusText};return n.status==101||n.status==204||n.status==205||n.status==304?new Response(null,r):new Response(n.body,r)}e(xe,"deserialize");var er="worker.js";var Ie=class{static{e(this,"Settings")}get ZUPLO_GCP_BUNDLE_BUCKET_NAME(){return Deno.env.get("ZUPLO_GCP_BUNDLE_BUCKET_NAME")}get ZUPLO_GCP_BUNDLE_BUCKET_PATH(){return $.join(this.DEPLOYMENT_NAME??"",this.ZUPLO_DEPLOYMENT_SECRET??"",er)}get ZUPLO_ACCOUNT_NAME(){return Deno.env.get("ZUPLO_ACCOUNT_NAME")}get ZUPLO_PROJECT_NAME(){return Deno.env.get("ZUPLO_PROJECT_NAME")}get DEPLOYMENT_NAME(){return Deno.env.get("DEPLOYMENT_NAME")}get ZUPLO_GCP_CLOUD_STORAGE_KEY(){return Deno.env.get("ZUPLO_GCP_CLOUD_STORAGE_KEY")}get ZUPLO_DEPLOYMENT_SECRET(){return Deno.env.get("ZUPLO_DEPLOYMENT_SECRET")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get SHOULD_LOAD_ENV_VARS(){return!!(se.ZUPLO_ACCOUNT_NAME&&se.ZUPLO_PROJECT_NAME&&se.MANAGEMENT_API_URL&&se.ZUPLO_AUTH_API_JWT)}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get ZUPLO_AUTH_API_JWT(){return Deno.env.get("__ZUPLO_AUTH_API_JWT")}get MANAGEMENT_API_URL(){return Deno.env.get("MANAGEMENT_API_URL")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},se=new Ie,rr=se;async function Ue(n,r){return await Deno.writeTextFile(n,r,{create:!0}),n}e(Ue,"createEnvVarsFile");function Be(n,r,o,i,u){let s=`import "${n}?version=${Date.now()}";`,c=o?`import "${o}";`:"",l=`import "${i}?version=${Date.now()}";`,h=u?`import "${u}";`:"";return[s,[...r],c,l,h].join(Deno.build.os==="windows"?ne.EOL.CRLF:ne.EOL.LF)}e(Be,"createExternallyLinkedZuploScript");function ke(n){let r=Ur(n.isLocal),o=Br(n.env);return[r,o].join(Deno.build.os==="windows"?ne.EOL.CRLF:ne.EOL.LF)}e(ke,"createVarsContent");var tr=["__ZUPLO_DEPLOYMENT_NAME","__ZUPLO_LOGGING_ID","__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","__ZUPLO_METRICS_API_URL","__ZUPLO_REMOTE_LOG_URL","__ZUPLO_REMOTE_LOG_TOKEN","__ZUPLO_ASSETS_CDN_URL","__ZUPLO_AUTH_API_JWT","__ZUPLO_EXTERNAL_SERVICES","MANAGEMENT_API_URL"],xr=tr.filter(n=>!["__ZUPLO_REMOTE_LOG_URL","__ZUPLO_METRICS_API_URL"].includes(n)),Ir=["__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","SYSTEM_LOG_LEVEL","PROJECT_ID","RUNTIME_ENV","LOGGING_ID","__ZUPLO_LOGGING_ID","GIT_SHA","MANAGEMENT_API_URL","__ZUPLO_MOCK_API_KEYS","__ZUPLO_AUTH_API_JWT"];function Ur(n){let r=Deno.env.toObject(),o=`//#region System Variables

`;if(n)for(let i of Ir)o+=`self['${i}'] = ${X(r[i])};
`;else if(rr.IS_TEST)for(let i of xr)i==="__ZUPLO_DEPLOYMENT_NAME"?o+=`self['${i}'] = ${X(r.DEPLOYMENT_NAME)};
`:o+=`self['${i}'] = \`${X(r[i])}\`;
`;else for(let i of tr)i==="__ZUPLO_DEPLOYMENT_NAME"?o+=`self['${i}'] = ${X(r.DEPLOYMENT_NAME)};
`:o+=`self['${i}'] = ${X(r[i])};
`;return o+=`//#endregion

`,o}e(Ur,"_injectSystemVars");function Br(n){let r=`//#region Environment Variables

`;for(let[o,i]of n)r+=`self['${o}'] = ${X(i)};
`;return r+=`//#endregion

`,r}e(Br,"_injectVars");function X(n){return JSON.stringify(n)}e(X,"_encodeAndEscapeAsNecessary");var me="OkMessage",ge="ErrorMessage",_e="WebSocketMessage";var he=class{static{e(this,"WebSocketHandler")}socket;clientSocket;constructor(r){r.onopen=o=>{x.info("socket onopen")},r.onmessage=o=>{x.info("socket onmessage"),this.getClientSocket().send(o.data)},r.onerror=o=>{x.info(`socket onerror: ${JSON.stringify(o)}`)},r.onclose=o=>{x.info("socket onclose"),this.getClientSocket().close()},this.socket=r}async setClientSocket(r){if(this.clientSocket)throw new Error("clientSocket is already set");r.onmessage=i=>{this.socket.send(i.data)},r.onclose=i=>{this.socket.close()};let o=0;for(;o<=3;)x.info(`Verifying if clientSocket is ready, state: ${r.readyState} `),r.readyState===WebSocket.OPEN?o=4:(o++,await new Promise(i=>setTimeout(i,o*500)));if(r.readyState!==WebSocket.OPEN)throw new Error("clientSocket connection cannot be established");this.clientSocket=r}getClientSocket(){if(!this.clientSocket)throw new Error("clientSocket is not available");return this.clientSocket}};var Ee=class{static{e(this,"LocalWorkerExecutor")}options;workerFilePath;workerContext;currentWorker;currentEnvVarsFilePath;pendingRequests=new Map;constructor(r){this.options=r,this.workerFilePath=$.toFileUrl(`${this.deriveModuleBasedir()}/${Ne}`),this.workerContext={env:new Map,isLocal:!0}}initializeWorker(){this.currentWorker&&this.currentWorker.terminate(),delete this.currentWorker,this.currentWorker=new Worker(this.workerFilePath,{type:"module",deno:{permissions:{env:!1,ffi:!1,hrtime:!1,net:!0,read:!0,run:!1,write:!1}}}),this.currentWorker.postMessage({context:this.workerContext}),this.currentWorker.onmessage=r=>{try{if(r.data._type===me||r.data._type===ge||r.data._type===_e){let o=r.data._requestId;if(o){let i=this.pendingRequests.get(o);i&&i(r)}}else x.error(r)}catch(o){x.error("Unexpected error while responding to postMessage from worker",o)}}}preparePromise(r,o){return new Promise((u,s)=>{this.pendingRequests.set(r,async c=>{try{if(c.data._type===me){let l=xe(c.data.response);u(l)}else if(c.data._type===ge)s(c.data.error);else if(c.data._type===_e&&o){let l=new WebSocket(c.data.websocket.url),{socket:h,response:g}=Deno.upgradeWebSocket(o);await new he(h).setClientSocket(l),u(g)}else x.error(c),s(c)}catch(l){x.error("Unexpected error while responding to postMessage from worker",l),s(l)}})})}deriveModuleBasedir(){return $.dirname(this.options.workerModulePath)}async writeWorkerScript(r){let o=import.meta.resolve("./worker-prologue.ts"),i=import.meta.resolve("./worker-epilogue.ts");this.currentEnvVarsFilePath=await Ue(`${this.deriveModuleBasedir()}/${Xe}`,ke(r));let u=Be($.toFileUrl(this.currentEnvVarsFilePath).toString(),this.linkPolyfills(r),o,$.toFileUrl(this.options.workerModulePath).toString(),i);ye.IS_VERBOSE_DEBUG&&x.info(u);let s=`${this.deriveModuleBasedir()}/${Ne}`;return await Deno.writeTextFile(s,u),new URL(`?version=${Date.now()}`,$.toFileUrl(s))}linkPolyfills(r){return[`import { URLPattern } from "${import.meta.resolve("../common-impl/polyfills/urlpattern-polyfill-6.0.2.js")}";`]}async init(){x.debug("Initializing local-executor"),await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),this.initializeWorker()}initializeVars(){return Promise.resolve(new Map(Object.entries(Deno.env.toObject())))}async initializeWorkerContents(){}async reloadScript(r){x.info("Reloading the contents of the zup locally");try{return await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),await this.initializeWorker(),new Response(null,{status:ie.Status.NoContent})}catch(o){return x.error("Unexpected error while responding to __/zuplo/reload",o),new Response(null,{status:ie.Status.InternalServerError})}}invalidateScript(r){throw new Error("Not implemented for local executor")}async execute(r){try{if(!this.currentWorker)return new Response(null,{status:ie.Status.ServiceUnavailable});let o=crypto.randomUUID();return this.currentWorker.postMessage({_requestId:o,request:await Ae(r)}),this.preparePromise(o,r)}catch(o){return x.error("Unexpected error while trying to execute the current request in local-executor worker.",o),new Response(null,{status:ie.Status.InternalServerError})}}};var ae,nr;async function ir(n){let r;n?.sourceDirectory?(r=n.sourceDirectory,x.debug(`Using passed in sourceDirectory of: ${r}`)):r=$.resolve(Deno.cwd());let o=$.join(r,Ce,Je),i=$.join(r,Ce,Qe);ae=new Ee({sourceDirectory:r,workerModulePath:o,invalidWorkerModulePath:i});let u=ye.PROD_SERVER_PORT;n?.port&&(u=parseInt(n.port),x.debug(`Using passed in port of: ${n.port}`)),nr=new Ve({port:u,handler:kr}),await nr.listenAndServe()}e(ir,"start");async function or(){await ae.init()}e(or,"postStart");function kr(n){return n.url&&n.url.endsWith("__/zuplo/reload")?ae.reloadScript(n):n.url&&n.url.endsWith("__/zuplo/invalid-build")?ae.invalidateScript(n):ae.execute(n)}e(kr,"handler");await Fe({export:!0,allowEmptyValues:!0,examplePath:""});await x.setup({handlers:{console:new de("DEBUG")},loggers:{default:{level:Deno.env.get("DENO_LOG_LEVEL")??"INFO",handlers:["console"]}}});var sr=We(Deno.args),Fr=ir({sourceDirectory:sr.sourceDirectory,port:sr.port}),Wr=or();await Promise.all([Fr,Wr]);
