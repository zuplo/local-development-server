var tr=Object.defineProperty;var e=(a,r)=>tr(a,"name",{value:r,configurable:!0});import{bundle as Rr,transpile as Ur}from"https://deno.land/x/emit@0.24.1/mod.ts";import{format as Se}from"https://deno.land/std@0.195.0/datetime/mod.ts";import{load as Te}from"https://deno.land/std@0.195.0/dotenv/mod.ts";import{createOAuth2Token as jr}from"https://deno.land/x/deno_gcp_admin@0.0.5/auth.ts";import{parse as Pe}from"https://deno.land/std@0.195.0/flags/mod.ts";import{Server as De}from"https://deno.land/std@0.195.0/http/server.ts";import*as K from"https://deno.land/std@0.195.0/fs/mod.ts";import*as Y from"https://deno.land/std@0.195.0/http/http_status.ts";import*as A from"https://deno.land/std@0.195.0/log/mod.ts";import*as k from"https://deno.land/std@0.195.0/path/mod.ts";import{assert as Br,assertAlmostEquals as Vr,assertArrayIncludes as zr,assertEquals as Gr,assertExists as Kr,assertFalse as Yr,assertInstanceOf as Zr,assertIsError as qr,assertMatch as Hr,assertNotEquals as Jr,assertNotMatch as Xr,assertNotStrictEquals as Qr,assertObjectMatch as et,assertRejects as rt,assertStrictEquals as tt,assertStringIncludes as nt,assertThrows as it,equal as ot,fail as st,unimplemented as at,unreachable as ct}from"https://deno.land/std@0.195.0/testing/asserts.ts";import{afterAll as lt,afterEach as ft,beforeAll as pt,beforeEach as dt,describe as yt,it as _t}from"https://deno.land/std@0.195.0/testing/bdd.ts";var nr=Object.getOwnPropertyNames,R=e((a,r)=>e(function(){return r||(0,a[nr(a)[0]])((r={exports:{}}).exports,r),r.exports},"__require"),"__commonJS"),ir=R({"node_modules/secure-json-parse/index.js"(a,r){"use strict";var n=typeof Buffer<"u",i=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,u=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function s(_,P,O){O==null&&P!==null&&typeof P=="object"&&(O=P,P=void 0),n&&Buffer.isBuffer(_)&&(_=_.toString()),_&&_.charCodeAt(0)===65279&&(_=_.slice(1));let l=JSON.parse(_,P);if(l===null||typeof l!="object")return l;let h=O&&O.protoAction||"error",o=O&&O.constructorAction||"error";if(h==="ignore"&&o==="ignore")return l;if(h!=="ignore"&&o!=="ignore"){if(i.test(_)===!1&&u.test(_)===!1)return l}else if(h!=="ignore"&&o==="ignore"){if(i.test(_)===!1)return l}else if(u.test(_)===!1)return l;return c(l,{protoAction:h,constructorAction:o,safe:O&&O.safe})}e(s,"_parse");function c(_,{protoAction:P="error",constructorAction:O="error",safe:l}={}){let h=[_];for(;h.length;){let o=h;h=[];for(let y of o){if(P!=="ignore"&&Object.prototype.hasOwnProperty.call(y,"__proto__")){if(l===!0)return null;if(P==="error")throw new SyntaxError("Object contains forbidden prototype property");delete y.__proto__}if(O!=="ignore"&&Object.prototype.hasOwnProperty.call(y,"constructor")&&Object.prototype.hasOwnProperty.call(y.constructor,"prototype")){if(l===!0)return null;if(O==="error")throw new SyntaxError("Object contains forbidden prototype property");delete y.constructor}for(let m in y){let p=y[m];p&&typeof p=="object"&&h.push(p)}}}return _}e(c,"filter");function d(_,P,O){let l=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(_,P,O)}finally{Error.stackTraceLimit=l}}e(d,"parse");function T(_,P){let O=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(_,P,{safe:!0})}catch{return null}finally{Error.stackTraceLimit=O}}e(T,"safeParse"),r.exports=d,r.exports.default=d,r.exports.parse=d,r.exports.safeParse=T,r.exports.scan=c}}),Me=R({"lib/utils/is-object.js"(a,r){"use strict";r.exports=n;function n(i){return Object.prototype.toString.apply(i)==="[object Object]"}e(n,"isObject")}}),Z=R({"lib/constants.js"(a,r){"use strict";r.exports={DATE_FORMAT:"yyyy-mm-dd HH:MM:ss.l o",DATE_FORMAT_SIMPLE:"HH:MM:ss.l",ERROR_LIKE_KEYS:["err","error"],MESSAGE_KEY:"msg",LEVEL_KEY:"level",LEVEL_LABEL:"levelLabel",TIMESTAMP_KEY:"time",LEVELS:{default:"USERLVL",60:"FATAL",50:"ERROR",40:"WARN",30:"INFO",20:"DEBUG",10:"TRACE"},LEVEL_NAMES:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},LOGGER_KEYS:["pid","hostname","name","level","time","timestamp","caller"]}}}),le=R({"lib/utils/join-lines-with-indentation.js"(a,r){"use strict";r.exports=n;function n({input:i,ident:u="    ",eol:s=`
`}){let c=i.split(/\r?\n/);for(let d=1;d<c.length;d+=1)c[d]=u+c[d];return c.join(s)}e(n,"joinLinesWithIndentation")}}),or=R({"node_modules/fast-safe-stringify/index.js"(a,r){r.exports=d,d.default=d,d.stable=O,d.stableStringify=O;var n="[...]",i="[Circular]",u=[],s=[];function c(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}e(c,"defaultOptions");function d(o,y,m,p){typeof p>"u"&&(p=c()),_(o,"",0,[],void 0,0,p);var v;try{s.length===0?v=JSON.stringify(o,y,m):v=JSON.stringify(o,h(y),m)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;u.length!==0;){var E=u.pop();E.length===4?Object.defineProperty(E[0],E[1],E[3]):E[0][E[1]]=E[2]}}return v}e(d,"stringify");function T(o,y,m,p){var v=Object.getOwnPropertyDescriptor(p,m);v.get!==void 0?v.configurable?(Object.defineProperty(p,m,{value:o}),u.push([p,m,y,v])):s.push([y,m,o]):(p[m]=o,u.push([p,m,y]))}e(T,"setReplace");function _(o,y,m,p,v,E,D){E+=1;var L;if(typeof o=="object"&&o!==null){for(L=0;L<p.length;L++)if(p[L]===o){T(i,o,y,v);return}if(typeof D.depthLimit<"u"&&E>D.depthLimit){T(n,o,y,v);return}if(typeof D.edgesLimit<"u"&&m+1>D.edgesLimit){T(n,o,y,v);return}if(p.push(o),Array.isArray(o))for(L=0;L<o.length;L++)_(o[L],L,L,p,o,E,D);else{var S=Object.keys(o);for(L=0;L<S.length;L++){var M=S[L];_(o[M],M,L,p,o,E,D)}}p.pop()}}e(_,"decirc");function P(o,y){return o<y?-1:o>y?1:0}e(P,"compareFunction");function O(o,y,m,p){typeof p>"u"&&(p=c());var v=l(o,"",0,[],void 0,0,p)||o,E;try{s.length===0?E=JSON.stringify(v,y,m):E=JSON.stringify(v,h(y),m)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;u.length!==0;){var D=u.pop();D.length===4?Object.defineProperty(D[0],D[1],D[3]):D[0][D[1]]=D[2]}}return E}e(O,"deterministicStringify");function l(o,y,m,p,v,E,D){E+=1;var L;if(typeof o=="object"&&o!==null){for(L=0;L<p.length;L++)if(p[L]===o){T(i,o,y,v);return}try{if(typeof o.toJSON=="function")return}catch{return}if(typeof D.depthLimit<"u"&&E>D.depthLimit){T(n,o,y,v);return}if(typeof D.edgesLimit<"u"&&m+1>D.edgesLimit){T(n,o,y,v);return}if(p.push(o),Array.isArray(o))for(L=0;L<o.length;L++)l(o[L],L,L,p,o,E,D);else{var S={},M=Object.keys(o).sort(P);for(L=0;L<M.length;L++){var x=M[L];l(o[x],x,L,p,o,E,D),S[x]=o[x]}if(typeof v<"u")u.push([v,y,o]),v[y]=S;else return S}p.pop()}}e(l,"deterministicDecirc");function h(o){return o=typeof o<"u"?o:function(y,m){return m},function(y,m){if(s.length>0)for(var p=0;p<s.length;p++){var v=s[p];if(v[1]===y&&v[0]===m){m=v[2],s.splice(p,1);break}}return o.call(this,y,m)}}e(h,"replaceGetterValues")}}),sr=R({"lib/utils/prettify-error.js"(a,r){"use strict";r.exports=i;var n=le();function i({keyName:u,lines:s,eol:c,ident:d}){let T="",_=n({input:s,ident:d,eol:c}),P=`${d}${u}: ${_}${c}`.split(c);for(let O=0;O<P.length;O+=1){O!==0&&(T+=c);let l=P[O];if(/^\s*"stack"/.test(l)){let h=/^(\s*"stack":)\s*(".*"),?$/.exec(l);if(h&&h.length===3){let o=/^\s*/.exec(l)[0].length+4,y=" ".repeat(o),m=h[2];T+=h[1]+c+y+JSON.parse(m).replace(/\n/g,c+y)}else T+=l}else T+=l}return T}e(i,"prettifyError")}}),we=R({"lib/utils/prettify-object.js"(a,r){"use strict";r.exports=c;var{LOGGER_KEYS:n}=Z(),i=or(),u=le(),s=sr();function c({log:d,excludeLoggerKeys:T=!0,skipKeys:_=[],context:P}){let{EOL:O,IDENT:l,customPrettifiers:h,errorLikeObjectKeys:o,objectColorizer:y,singleLine:m}=P,p=[].concat(_);T===!0&&Array.prototype.push.apply(p,n);let v="",{plain:E,errors:D}=Object.entries(d).reduce(({plain:L,errors:S},[M,x])=>{if(p.includes(M)===!1){let C=typeof h[M]=="function"?h[M](x,M,d):x;o.includes(M)?S[M]=C:L[M]=C}return{plain:L,errors:S}},{plain:{},errors:{}});return m?(Object.keys(E).length>0&&(v+=y.greyMessage(i(E))),v+=O,v=v.replace(/\\\\/gi,"\\")):Object.entries(E).forEach(([L,S])=>{let M=typeof h[L]=="function"?S:i(S,null,2);if(M===void 0)return;M=M.replace(/\\\\/gi,"\\");let x=u({input:M,ident:l,eol:O});v+=`${l}${L}:${x.startsWith(O)?"":" "}${x}${O}`}),Object.entries(D).forEach(([L,S])=>{let M=typeof h[L]=="function"?S:i(S,null,2);M!==void 0&&(v+=s({keyName:L,lines:M,eol:O,ident:l}))}),v}e(c,"prettifyObject")}}),ar=R({"lib/utils/prettify-error-log.js"(a,r){"use strict";r.exports=c;var{LOGGER_KEYS:n}=Z(),i=Me(),u=le(),s=we();function c({log:d,context:T}){let{EOL:_,IDENT:P,errorProps:O,messageKey:l}=T,h=d.stack,o=u({input:h,ident:P,eol:_}),y=`${P}${o}${_}`;if(O.length>0){let m=n.concat(l,"type","stack"),p;O[0]==="*"?p=Object.keys(d).filter(v=>m.includes(v)===!1):p=O.filter(v=>m.includes(v)===!1);for(let v=0;v<p.length;v+=1){let E=p[v];if(E in d){if(i(d[E])){let D=s({log:d[E],excludeLoggerKeys:!1,context:{...T,IDENT:P+P}});y=`${y}${P}${E}: {${_}${D}${P}}${_}`;continue}y=`${y}${P}${E}: ${d[E]}${_}`}}}return y}e(c,"prettifyErrorLog")}}),xe=R({"lib/utils/split-property-key.js"(a,r){"use strict";r.exports=n;function n(i){let u=[],s=!1,c="";for(let d=0;d<i.length;d++){let T=i.charAt(d);if(T==="\\"){s=!0;continue}if(s){s=!1,c+=T;continue}if(T==="."){u.push(c),c="";continue}c+=T}return c.length&&u.push(c),u}e(n,"splitPropertyKey")}}),X=R({"lib/utils/get-property-value.js"(a,r){"use strict";r.exports=i;var n=xe();function i(u,s){let c=Array.isArray(s)?s:n(s);for(let d of c){if(!Object.prototype.hasOwnProperty.call(u,d))return;u=u[d]}return u}e(i,"getPropertyValue")}}),cr=R({"lib/utils/prettify-level.js"(a,r){"use strict";r.exports=i;var n=X();function i({log:u,context:s}){let{colorizer:c,customLevels:d,customLevelNames:T,levelKey:_}=s,P=s.customPrettifiers?.level,O=n(u,_);if(O!==void 0)return P?P(O):c(O,{customLevels:d,customLevelNames:T})}e(i,"prettifyLevel")}}),ur=R({"lib/utils/interpret-conditionals.js"(a,r){"use strict";r.exports=i;var n=X();function i(u,s){return u=u.replace(/{if (.*?)}(.*?){end}/g,c),u=u.replace(/{if (.*?)}/g,""),u=u.replace(/{end}/g,""),u.replace(/\s+/g," ").trim();function c(d,T,_){let P=n(s,T);return P&&_.includes(T)?_.replace(new RegExp("{"+T+"}","g"),P):""}e(c,"replacer")}e(i,"interpretConditionals")}}),lr=R({"lib/utils/prettify-message.js"(a,r){"use strict";r.exports=s;var{LEVELS:n}=Z(),i=X(),u=ur();function s({log:c,context:d}){let{colorizer:T,customLevels:_,levelKey:P,levelLabel:O,messageFormat:l,messageKey:h,useOnlyCustomProps:o}=d;if(l&&typeof l=="string"){let y=u(l,c),m=String(y).replace(/{([^{}]+)}/g,function(p,v){let E;return v===O&&(E=i(c,P))!==void 0?(o?_===void 0:_[E]===void 0)?n[E]:_[E]:i(c,v)||""});return T.message(m)}if(l&&typeof l=="function"){let y=l(c,h,O);return T.message(y)}if(h in c&&!(typeof c[h]!="string"&&typeof c[h]!="number"&&typeof c[h]!="boolean"))return T.message(c[h])}e(s,"prettifyMessage")}}),fr=R({"lib/utils/prettify-metadata.js"(a,r){"use strict";r.exports=n;function n({log:i,context:u}){let s=u.customPrettifiers,c="";if(i.name||i.pid||i.hostname){if(c+="(",i.name&&(c+=s.name?s.name(i.name):i.name),i.pid){let d=s.pid?s.pid(i.pid):i.pid;i.name&&i.pid?c+="/"+d:c+=d}i.hostname&&(c+=`${c==="("?"on":" on"} ${s.hostname?s.hostname(i.hostname):i.hostname}`),c+=")"}if(i.caller&&(c+=`${c===""?"":" "}<${s.caller?s.caller(i.caller):i.caller}>`),c!=="")return c}e(n,"prettifyMetadata")}}),pr=R({"node_modules/dateformat/lib/dateformat.js"(a,r){"use strict";function n(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?n=e(function(s){return typeof s},"_typeof2"):n=e(function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},"_typeof2"),n(i)}e(n,"_typeof"),function(i){var u=arguments,s=function(){var O=/d{1,4}|D{3,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|W{1,2}|[LlopSZN]|"[^"]*"|'[^']*'/g,l=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,h=/[^-+\dA-Z]/g;return function(o,y,m,p){if(u.length===1&&P(o)==="string"&&!/\d/.test(o)&&(y=o,o=void 0),o=o||o===0?o:new Date,o instanceof Date||(o=new Date(o)),isNaN(o))throw TypeError("Invalid date");y=String(s.masks[y]||y||s.masks.default);var v=y.slice(0,4);(v==="UTC:"||v==="GMT:")&&(y=y.slice(4),m=!0,v==="GMT:"&&(p=!0));var E=e(function(){return m?"getUTC":"get"},"_2"),D=e(function(){return o[E()+"Date"]()},"d"),L=e(function(){return o[E()+"Day"]()},"D2"),S=e(function(){return o[E()+"Month"]()},"m"),M=e(function(){return o[E()+"FullYear"]()},"y2"),x=e(function(){return o[E()+"Hours"]()},"H"),C=e(function(){return o[E()+"Minutes"]()},"M"),F=e(function(){return o[E()+"Seconds"]()},"s"),$=e(function(){return o[E()+"Milliseconds"]()},"L"),j=e(function(){return m?0:o.getTimezoneOffset()},"o"),B=e(function(){return T(o)},"W"),G=e(function(){return _(o)},"N"),V={d:e(function(){return D()},"d"),dd:e(function(){return c(D())},"dd"),ddd:e(function(){return s.i18n.dayNames[L()]},"ddd"),DDD:e(function(){return d({y:M(),m:S(),d:D(),_:E(),dayName:s.i18n.dayNames[L()],short:!0})},"DDD"),dddd:e(function(){return s.i18n.dayNames[L()+7]},"dddd"),DDDD:e(function(){return d({y:M(),m:S(),d:D(),_:E(),dayName:s.i18n.dayNames[L()+7]})},"DDDD"),m:e(function(){return S()+1},"m"),mm:e(function(){return c(S()+1)},"mm"),mmm:e(function(){return s.i18n.monthNames[S()]},"mmm"),mmmm:e(function(){return s.i18n.monthNames[S()+12]},"mmmm"),yy:e(function(){return String(M()).slice(2)},"yy"),yyyy:e(function(){return c(M(),4)},"yyyy"),h:e(function(){return x()%12||12},"h"),hh:e(function(){return c(x()%12||12)},"hh"),H:e(function(){return x()},"H"),HH:e(function(){return c(x())},"HH"),M:e(function(){return C()},"M"),MM:e(function(){return c(C())},"MM"),s:e(function(){return F()},"s"),ss:e(function(){return c(F())},"ss"),l:e(function(){return c($(),3)},"l"),L:e(function(){return c(Math.floor($()/10))},"L"),t:e(function(){return x()<12?s.i18n.timeNames[0]:s.i18n.timeNames[1]},"t"),tt:e(function(){return x()<12?s.i18n.timeNames[2]:s.i18n.timeNames[3]},"tt"),T:e(function(){return x()<12?s.i18n.timeNames[4]:s.i18n.timeNames[5]},"T"),TT:e(function(){return x()<12?s.i18n.timeNames[6]:s.i18n.timeNames[7]},"TT"),Z:e(function(){return p?"GMT":m?"UTC":(String(o).match(l)||[""]).pop().replace(h,"").replace(/GMT\+0000/g,"UTC")},"Z"),o:e(function(){return(j()>0?"-":"+")+c(Math.floor(Math.abs(j())/60)*100+Math.abs(j())%60,4)},"o"),p:e(function(){return(j()>0?"-":"+")+c(Math.floor(Math.abs(j())/60),2)+":"+c(Math.floor(Math.abs(j())%60),2)},"p"),S:e(function(){return["th","st","nd","rd"][D()%10>3?0:(D()%100-D()%10!=10)*D()%10]},"S"),W:e(function(){return B()},"W"),WW:e(function(){return c(B())},"WW"),N:e(function(){return G()},"N")};return y.replace(O,function(g){return g in V?V[g]():g.slice(1,g.length-1)})}}();s.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",paddedShortDate:"mm/dd/yyyy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},s.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"],timeNames:["a","p","am","pm","A","P","AM","PM"]};var c=e(function(l,h){for(l=String(l),h=h||2;l.length<h;)l="0"+l;return l},"pad2"),d=e(function(l){var h=l.y,o=l.m,y=l.d,m=l._,p=l.dayName,v=l.short,E=v===void 0?!1:v,D=new Date,L=new Date;L.setDate(L[m+"Date"]()-1);var S=new Date;S.setDate(S[m+"Date"]()+1);var M=e(function(){return D[m+"Date"]()},"today_d2"),x=e(function(){return D[m+"Month"]()},"today_m2"),C=e(function(){return D[m+"FullYear"]()},"today_y2"),F=e(function(){return L[m+"Date"]()},"yesterday_d2"),$=e(function(){return L[m+"Month"]()},"yesterday_m2"),j=e(function(){return L[m+"FullYear"]()},"yesterday_y2"),B=e(function(){return S[m+"Date"]()},"tomorrow_d2"),G=e(function(){return S[m+"Month"]()},"tomorrow_m2"),V=e(function(){return S[m+"FullYear"]()},"tomorrow_y2");return C()===h&&x()===o&&M()===y?E?"Tdy":"Today":j()===h&&$()===o&&F()===y?E?"Ysd":"Yesterday":V()===h&&G()===o&&B()===y?E?"Tmw":"Tomorrow":p},"getDayName2"),T=e(function(l){var h=new Date(l.getFullYear(),l.getMonth(),l.getDate());h.setDate(h.getDate()-(h.getDay()+6)%7+3);var o=new Date(h.getFullYear(),0,4);o.setDate(o.getDate()-(o.getDay()+6)%7+3);var y=h.getTimezoneOffset()-o.getTimezoneOffset();h.setHours(h.getHours()-y);var m=(h-o)/(864e5*7);return 1+Math.floor(m)},"getWeek2"),_=e(function(l){var h=l.getDay();return h===0&&(h=7),h},"getDayOfWeek2"),P=e(function(l){return l===null?"null":l===void 0?"undefined":n(l)!=="object"?n(l):Array.isArray(l)?"array":{}.toString.call(l).slice(8,-1).toLowerCase()},"kindOf2");typeof define=="function"&&define.amd?define(function(){return s}):(typeof a>"u"?"undefined":n(a))==="object"?r.exports=s:i.dateFormat=s}(void 0)}}),be=R({"lib/utils/is-valid-date.js"(a,r){"use strict";r.exports=n;function n(i){return i instanceof Date&&!Number.isNaN(i.getTime())}e(n,"isValidDate")}}),dr=R({"lib/utils/create-date.js"(a,r){"use strict";r.exports=i;var n=be();function i(u){let s=new Date(u);return n(s)||(s=new Date(+u)),s}e(i,"createDate")}}),yr=R({"lib/utils/format-time.js"(a,r){"use strict";r.exports=d;var{DATE_FORMAT:n,DATE_FORMAT_SIMPLE:i}=Z(),u=pr(),s=dr(),c=be();function d(T,_=!1){if(_===!1)return T;let P=s(T);if(!c(P))return T;if(_===!0)return u(P,i);let O=_.toUpperCase();if(O==="SYS:STANDARD")return u(P,n);let l=O.substr(0,4);return l==="SYS:"||l==="UTC:"?l==="UTC:"?u(P,_):u(P,_.slice(4)):u(P,`UTC:${_}`)}e(d,"formatTime")}}),_r=R({"lib/utils/prettify-time.js"(a,r){"use strict";r.exports=i;var n=yr();function i({log:u,context:s}){let{timestampKey:c,translateTime:d}=s,T=s.customPrettifiers?.time,_=null;if(c in u?_=u[c]:"timestamp"in u&&(_=u.timestamp),_===null)return;let P=d?n(_,d):_;return T?T(P):`[${P}]`}e(i,"prettifyTime")}}),mr=R({"node_modules/fast-copy/dist/cjs/index.cjs"(a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var r=Function.prototype.toString,n=Object.create,i=Object.prototype.toString,u=function(){function t(){this._keys=[],this._values=[]}return e(t,"LegacyCache2"),t.prototype.has=function(f){return!!~this._keys.indexOf(f)},t.prototype.get=function(f){return this._values[this._keys.indexOf(f)]},t.prototype.set=function(f,w){this._keys.push(f),this._values.push(w)},t}();function s(){return new u}e(s,"createCacheLegacy");function c(){return new WeakMap}e(c,"createCacheModern");var d=typeof WeakMap<"u"?c:s;function T(t){if(!t)return n(null);var f=t.constructor;if(f===Object)return t===Object.prototype?{}:n(t);if(~r.call(f).indexOf("[native code]"))try{return new f}catch{}return n(t)}e(T,"getCleanClone");function _(t){var f="";return t.global&&(f+="g"),t.ignoreCase&&(f+="i"),t.multiline&&(f+="m"),t.unicode&&(f+="u"),t.sticky&&(f+="y"),f}e(_,"getRegExpFlagsLegacy");function P(t){return t.flags}e(P,"getRegExpFlagsModern");var O=/test/g.flags==="g"?P:_;function l(t){var f=i.call(t);return f.substring(8,f.length-1)}e(l,"getTagLegacy");function h(t){return t[Symbol.toStringTag]||l(t)}e(h,"getTagModern");var o=typeof Symbol<"u"?h:l,y=Object.defineProperty,m=Object.getOwnPropertyDescriptor,p=Object.getOwnPropertyNames,v=Object.getOwnPropertySymbols,E=Object.prototype,D=E.hasOwnProperty,L=E.propertyIsEnumerable,S=typeof v=="function";function M(t){return p(t).concat(v(t))}e(M,"getStrictPropertiesModern");var x=S?M:p;function C(t,f,w){for(var U=x(t),I=0,W=U.length,N=void 0,b=void 0;I<W;++I)if(N=U[I],!(N==="callee"||N==="caller")){if(b=m(t,N),!b){f[N]=w.copier(t[N],w);continue}!b.get&&!b.set&&(b.value=w.copier(b.value,w));try{y(f,N,b)}catch{f[N]=b.value}}return f}e(C,"copyOwnPropertiesStrict");function F(t,f){var w=new f.Constructor;f.cache.set(t,w);for(var U=0,I=t.length;U<I;++U)w[U]=f.copier(t[U],f);return w}e(F,"copyArrayLoose");function $(t,f){var w=new f.Constructor;return f.cache.set(t,w),C(t,w,f)}e($,"copyArrayStrict");function j(t,f){return t.slice(0)}e(j,"copyArrayBuffer");function B(t,f){return t.slice(0,t.size,t.type)}e(B,"copyBlob");function G(t,f){return new f.Constructor(j(t.buffer))}e(G,"copyDataView");function V(t,f){return new f.Constructor(t.getTime())}e(V,"copyDate");function g(t,f){var w=new f.Constructor;return f.cache.set(t,w),t.forEach(function(U,I){w.set(I,f.copier(U,f))}),w}e(g,"copyMapLoose");function Ve(t,f){return C(t,g(t,f),f)}e(Ve,"copyMapStrict");function ze(t,f){var w=T(f.prototype);f.cache.set(t,w);for(var U in t)D.call(t,U)&&(w[U]=f.copier(t[U],f));return w}e(ze,"copyObjectLooseLegacy");function Ge(t,f){var w=T(f.prototype);f.cache.set(t,w);for(var U in t)D.call(t,U)&&(w[U]=f.copier(t[U],f));for(var I=v(t),W=0,N=I.length,b=void 0;W<N;++W)b=I[W],L.call(t,b)&&(w[b]=f.copier(t[b],f));return w}e(Ge,"copyObjectLooseModern");var Ke=S?Ge:ze;function Ye(t,f){var w=T(f.prototype);return f.cache.set(t,w),C(t,w,f)}e(Ye,"copyObjectStrict");function se(t,f){return new f.Constructor(t.valueOf())}e(se,"copyPrimitiveWrapper");function Ze(t,f){var w=new f.Constructor(t.source,O(t));return w.lastIndex=t.lastIndex,w}e(Ze,"copyRegExp");function J(t,f){return t}e(J,"copySelf");function Oe(t,f){var w=new f.Constructor;return f.cache.set(t,w),t.forEach(function(U){w.add(f.copier(U,f))}),w}e(Oe,"copySetLoose");function qe(t,f){return C(t,Oe(t,f),f)}e(qe,"copySetStrict");var He=Array.isArray,ae=Object.assign,Je=Object.getPrototypeOf||function(t){return t.__proto__},ve={array:F,arrayBuffer:j,blob:B,dataView:G,date:V,error:J,map:g,object:Ke,regExp:Ze,set:Oe},Xe=ae({},ve,{array:$,map:Ve,object:Ye,set:qe});function Qe(t){return{Arguments:t.object,Array:t.array,ArrayBuffer:t.arrayBuffer,Blob:t.blob,Boolean:se,DataView:t.dataView,Date:t.date,Error:t.error,Float32Array:t.arrayBuffer,Float64Array:t.arrayBuffer,Int8Array:t.arrayBuffer,Int16Array:t.arrayBuffer,Int32Array:t.arrayBuffer,Map:t.map,Number:se,Object:t.object,Promise:J,RegExp:t.regExp,Set:t.set,String:se,WeakMap:J,WeakSet:J,Uint8Array:t.arrayBuffer,Uint8ClampedArray:t.arrayBuffer,Uint16Array:t.arrayBuffer,Uint32Array:t.arrayBuffer,Uint64Array:t.arrayBuffer}}e(Qe,"getTagSpecificCopiers");function ce(t){var f=ae({},ve,t),w=Qe(f),U=w.Array,I=w.Object;function W(N,b){if(b.prototype=b.Constructor=void 0,!N||typeof N!="object")return N;if(b.cache.has(N))return b.cache.get(N);if(b.prototype=Je(N),b.Constructor=b.prototype&&b.prototype.constructor,!b.Constructor||b.Constructor===Object)return I(N,b);if(He(N))return U(N,b);var ue=w[o(N)];return ue?ue(N,b):typeof N.then=="function"?N:I(N,b)}return e(W,"copier"),e(function(b){return W(b,{Constructor:void 0,cache:d(),copier:W,prototype:void 0})},"copy")}e(ce,"createCopier");function Le(t){return ce(ae({},Xe,t))}e(Le,"createStrictCopier");var er=Le({}),rr=ce({});a.copyStrict=er,a.createCopier=ce,a.createStrictCopier=Le,a.default=rr}}),Er=R({"lib/utils/delete-log-property.js"(a,r){"use strict";r.exports=u;var n=X(),i=xe();function u(s,c){let d=i(c),T=d.pop();s=n(s,d),s!==null&&typeof s=="object"&&Object.prototype.hasOwnProperty.call(s,T)&&delete s[T]}e(u,"deleteLogProperty")}}),gr=R({"lib/utils/filter-log.js"(a,r){"use strict";r.exports=s;var{createCopier:n}=mr(),i=n({}),u=Er();function s({log:c,context:d}){let{ignoreKeys:T,includeKeys:_}=d,P=i(c);if(_){let O={};return _.forEach(l=>{O[l]=P[l]}),O}return T.forEach(O=>{u(P,O)}),P}e(s,"filterLog")}}),hr=R({"lib/pretty.js"(a,r){r.exports=y;var n=ir(),i=Me(),u=ar(),s=cr(),c=lr(),d=fr(),T=we(),_=_r(),P=gr(),{LEVELS:O,LEVEL_KEY:l,LEVEL_NAMES:h}=Z(),o=e(m=>{try{return{value:n.parse(m,{protoAction:"remove"})}}catch(p){return{err:p}}},"jsonParser");function y(m){let p;if(i(m))p=m;else{let M=o(m);if(M.err||!i(M.value))return m+this.EOL;p=M.value}if(this.minimumLevel){let M;this.useOnlyCustomProps?M=this.customLevels:M=this.customLevelNames[this.minimumLevel]!==void 0;let x;if(M?x=this.customLevelNames[this.minimumLevel]:x=h[this.minimumLevel],x||(x=typeof this.minimumLevel=="string"?h[this.minimumLevel]:h[O[this.minimumLevel].toLowerCase()]),p[this.levelKey===void 0?l:this.levelKey]<x)return}let v=c({log:p,context:this.context});(this.ignoreKeys||this.includeKeys)&&(p=P({log:p,context:this.context}));let E=s({log:p,context:{...this.context,...this.context.customProperties}}),D=d({log:p,context:this.context}),L=_({log:p,context:this.context}),S="";if(this.levelFirst&&E&&(S=`${E}`),L&&S===""?S=`${L}`:L&&(S=`${S} ${L}`),!this.levelFirst&&E&&(S.length>0?S=`${S} ${E}`:S=E),D&&(S.length>0?S=`${S} ${D}:`:S=D),S.endsWith(":")===!1&&S!==""&&(S+=":"),v!==void 0&&(S.length>0?S=`${S} ${v}`:S=v),S.length>0&&!this.singleLine&&(S+=this.EOL),p.type==="Error"&&p.stack){let M=u({log:p,context:this.context});this.singleLine&&(S+=this.EOL),S+=M}else if(this.hideObject===!1){let M=[this.messageKey,this.levelKey,this.timestampKey].filter(C=>typeof p[C]=="string"||typeof p[C]=="number"||typeof p[C]=="boolean"),x=T({log:p,skipKeys:M,context:this.context});this.singleLine&&!/^\s$/.test(x)&&(S+=" "),S+=x}return S}e(y,"pretty")}}),Ne=hr();function Or(a){let r=Object.assign({},{EOL:`
`,IDENT:"    "},a);return Ne.bind({...r,context:r})}e(Or,"prettyFactory");var Ae=Or({colorizer:a=>a,colorize:!1,colorizeObjects:!1,crlf:!1,customColors:null,customLevels:null,customPrettifiers:{time:a=>`${a}`},errorLikeObjectKeys:["err","error"],errorProps:"",hideObject:!1,ignore:"hostname,pid,buildId,project_id",include:void 0,levelFirst:!1,levelKey:"level",levelLabel:"levelLabel",messageFormat:"",messageKey:"msg",minimumLevel:void 0,singleLine:!1,timestampKey:"timestamp",translateTime:"SYS:HH:MM:ss",useOnlyCustomProps:!0}),Q=class extends A.handlers.BaseHandler{static{e(this,"ConsoleHandler")}format(r){try{let n=JSON.parse(r.msg);return n.level=r.levelName,n.timestamp||(n.timestamp=r.datetime),delete n.hostname,Ae(n)}catch{return`${Se(r.datetime,"HH:mm:ss")} ${r.levelName}: ${Ae(r.msg)}`}}log(r){console.log(r)}};var fe="dist",Re="worker.js",pe="zup.js",Ue="env-vars.js",Ce="worker-invalid-build.js";var de=class{static{e(this,"Settings")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},vr=new de,ee=vr;async function ye(a){let r=Object.fromEntries(a.headers.entries()),n=await a.arrayBuffer(),i=a.url;return r["zuplo-forwarded-host"]&&(i=a.url.replace(r.host,r["zuplo-forwarded-host"]),i=i.replace(/^http:/,"https:")),{url:i,body:n,cache:a.cache,credentials:a.credentials,headers:r,integrity:a.integrity,keepalive:a.keepalive,method:a.method,mode:a.mode,redirect:a.redirect,referrer:a.referrer,referrerPolicy:a.referrerPolicy,window:null}}e(ye,"serialize");function _e(a){let r={headers:a.headers,status:a.status,statusText:a.statusText};return a.status==101||a.status==204||a.status==205||a.status==304?new Response(null,r):new Response(a.body,r)}e(_e,"deserialize");var Ie="worker.js";var me=class{static{e(this,"Settings")}get ZUPLO_GCP_BUNDLE_BUCKET_NAME(){return Deno.env.get("ZUPLO_GCP_BUNDLE_BUCKET_NAME")}get ZUPLO_GCP_BUNDLE_BUCKET_PATH(){return k.join(this.DEPLOYMENT_NAME??"",this.ZUPLO_DEPLOYMENT_SECRET??"",Ie)}get ZUPLO_ACCOUNT_NAME(){return Deno.env.get("ZUPLO_ACCOUNT_NAME")}get ZUPLO_PROJECT_NAME(){return Deno.env.get("ZUPLO_PROJECT_NAME")}get DEPLOYMENT_NAME(){return Deno.env.get("DEPLOYMENT_NAME")}get ZUPLO_GCP_CLOUD_STORAGE_KEY(){return Deno.env.get("ZUPLO_GCP_CLOUD_STORAGE_KEY")}get ZUPLO_DEPLOYMENT_SECRET(){return Deno.env.get("ZUPLO_DEPLOYMENT_SECRET")}get PROD_SERVER_PORT(){return Deno.env.get("PORT")?parseInt(Deno.env.get("PORT")):3e3}get SHOULD_LOAD_ENV_VARS(){return!!(q.ZUPLO_ACCOUNT_NAME&&q.ZUPLO_PROJECT_NAME&&q.MANAGEMENT_API_URL&&q.ZUPLO_AUTH_API_JWT)}get IS_TEST(){return!!Deno.env.get("DENO_TEST")}get ZUPLO_AUTH_API_JWT(){return Deno.env.get("__ZUPLO_AUTH_API_JWT")}get MANAGEMENT_API_URL(){return Deno.env.get("MANAGEMENT_API_URL")}get IS_VERBOSE_DEBUG(){return!!Deno.env.get("DENO_VERBOSE_DEBUG")}},q=new me,ke=q;async function Ee(a,r){return await Deno.writeTextFile(a,r,{create:!0}),a}e(Ee,"createEnvVarsFile");function ge(a,r,n,i,u){let s=`import "${a}?version=${Date.now()}";`,c=n?`import "${n}";`:"",d=`import "${i}?version=${Date.now()}";`,T=u?`import "${u}";`:"";return[s,[...r],c,d,T].join(Deno.build.os==="windows"?K.EOL.CRLF:K.EOL.LF)}e(ge,"createExternallyLinkedZuploScript");function he(a){let r=Tr(a.isLocal),n=Pr(a.env);return[r,n].join(Deno.build.os==="windows"?K.EOL.CRLF:K.EOL.LF)}e(he,"createVarsContent");var je=["__ZUPLO_DEPLOYMENT_NAME","__ZUPLO_LOGGING_ID","__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","__ZUPLO_METRICS_API_URL","__ZUPLO_REMOTE_LOG_URL","__ZUPLO_REMOTE_LOG_TOKEN","__ZUPLO_ASSETS_CDN_URL","__ZUPLO_AUTH_API_JWT","__ZUPLO_EXTERNAL_SERVICES","MANAGEMENT_API_URL"],Lr=je.filter(a=>!["__ZUPLO_REMOTE_LOG_URL","__ZUPLO_METRICS_API_URL"].includes(a)),Sr=["__ZUPLO_LOG_LEVEL","__ZUPLO_LOG_FORMAT","SYSTEM_LOG_LEVEL","PROJECT_ID","RUNTIME_ENV","LOGGING_ID","__ZUPLO_LOGGING_ID","GIT_SHA","MANAGEMENT_API_URL","__ZUPLO_MOCK_API_KEYS","__ZUPLO_AUTH_API_JWT"];function Tr(a){let r=Deno.env.toObject(),n=`//#region System Variables

`;if(a)for(let i of Sr)n+=`self['${i}'] = ${z(r[i])};
`;else if(ke.IS_TEST)for(let i of Lr)i==="__ZUPLO_DEPLOYMENT_NAME"?n+=`self['${i}'] = ${z(r.DEPLOYMENT_NAME)};
`:n+=`self['${i}'] = \`${z(r[i])}\`;
`;else for(let i of je)i==="__ZUPLO_DEPLOYMENT_NAME"?n+=`self['${i}'] = ${z(r.DEPLOYMENT_NAME)};
`:n+=`self['${i}'] = ${z(r[i])};
`;return n+=`//#endregion

`,n}e(Tr,"_injectSystemVars");function Pr(a){let r=`//#region Environment Variables

`;for(let[n,i]of a)r+=`self['${n}'] = ${z(i)};
`;return r+=`//#endregion

`,r}e(Pr,"_injectVars");function z(a){return JSON.stringify(a)}e(z,"_encodeAndEscapeAsNecessary");var re="OkMessage",te="ErrorMessage",ne="WebSocketMessage";var ie=class{static{e(this,"WebSocketHandler")}socket;clientSocket;constructor(r){r.onopen=n=>{A.info("socket onopen")},r.onmessage=n=>{A.info("socket onmessage"),this.getClientSocket().send(n.data)},r.onerror=n=>{A.info(`socket onerror: ${JSON.stringify(n)}`)},r.onclose=n=>{A.info("socket onclose"),this.getClientSocket().close()},this.socket=r}async setClientSocket(r){if(this.clientSocket)throw new Error("clientSocket is already set");r.onmessage=i=>{this.socket.send(i.data)},r.onclose=i=>{this.socket.close()};let n=0;for(;n<=3;)A.info(`Verifying if clientSocket is ready, state: ${r.readyState} `),r.readyState===WebSocket.OPEN?n=4:(n++,await new Promise(i=>setTimeout(i,n*500)));if(r.readyState!==WebSocket.OPEN)throw new Error("clientSocket connection cannot be established");this.clientSocket=r}getClientSocket(){if(!this.clientSocket)throw new Error("clientSocket is not available");return this.clientSocket}};var oe=class{static{e(this,"LocalWorkerExecutor")}options;workerFilePath;workerContext;currentWorker;currentEnvVarsFilePath;pendingRequests=new Map;constructor(r){this.options=r,this.workerFilePath=k.toFileUrl(`${this.deriveModuleBasedir()}/${pe}`),this.workerContext={env:new Map,isLocal:!0}}initializeWorker(){this.currentWorker&&this.currentWorker.terminate(),delete this.currentWorker,this.currentWorker=new Worker(this.workerFilePath,{type:"module",deno:{permissions:{env:!1,ffi:!1,hrtime:!1,net:!0,read:!1,run:!1,write:!1}}}),this.currentWorker.postMessage({context:this.workerContext}),this.currentWorker.onmessage=r=>{try{if(r.data._type===re||r.data._type===te||r.data._type===ne){let n=r.data._requestId;if(n){let i=this.pendingRequests.get(n);i&&i(r)}}else A.error(r)}catch(n){A.error("Unexpected error while responding to postMessage from worker",n)}}}preparePromise(r,n){return new Promise((u,s)=>{this.pendingRequests.set(r,async c=>{try{if(c.data._type===re){let d=_e(c.data.response);u(d)}else if(c.data._type===te)s(c.data.error);else if(c.data._type===ne&&n){let d=new WebSocket(c.data.websocket.url),{socket:T,response:_}=Deno.upgradeWebSocket(n);await new ie(T).setClientSocket(d),u(_)}else A.error(c),s(c)}catch(d){A.error("Unexpected error while responding to postMessage from worker",d),s(d)}})})}deriveModuleBasedir(){return k.dirname(this.options.workerModulePath)}async writeWorkerScript(r){let n=import.meta.resolve("./worker-prologue.ts"),i=import.meta.resolve("./worker-epilogue.ts");this.currentEnvVarsFilePath=await Ee(`${this.deriveModuleBasedir()}/${Ue}`,he(r));let u=ge(k.toFileUrl(this.currentEnvVarsFilePath).toString(),this.linkPolyfills(r),n,k.toFileUrl(this.options.workerModulePath).toString(),i);ee.IS_VERBOSE_DEBUG&&A.info(u);let s=`${this.deriveModuleBasedir()}/${pe}`;return await Deno.writeTextFile(s,u),new URL(`?version=${Date.now()}`,k.toFileUrl(s))}linkPolyfills(r){return[`import { URLPattern } from "${import.meta.resolve("../common-impl/polyfills/urlpattern-polyfill-6.0.2.js")}";`]}async init(){A.info("Initializing local-executor"),await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),this.initializeWorker()}initializeVars(){return Promise.resolve(new Map(Object.entries(Deno.env.toObject())))}async initializeWorkerContents(){}async reloadScript(r){A.info("Reloading the contents of the zup locally");try{return await this.initializeWorkerContents(),this.workerContext.env=await this.initializeVars(),this.workerFilePath=await this.writeWorkerScript(this.workerContext),await this.initializeWorker(),new Response(null,{status:Y.Status.NoContent})}catch(n){return A.error("Unexpected error while responding to __/zuplo/reload",n),new Response(null,{status:Y.Status.InternalServerError})}}invalidateScript(r){throw new Error("Not implemented for local executor")}async execute(r){try{if(!this.currentWorker)return new Response(null,{status:Y.Status.ServiceUnavailable});let n=crypto.randomUUID();return this.currentWorker.postMessage({_requestId:n,request:await ye(r)}),this.preparePromise(n,r)}catch(n){return A.error("Unexpected error while trying to execute the current request in local-executor worker.",n),new Response(null,{status:Y.Status.InternalServerError})}}};var H,We;async function Fe(a){let r;a?.sourceDirectory?(r=a.sourceDirectory,A.info(`Using passed in sourceDirectory of: ${r}`)):r=k.resolve(Deno.cwd());let n=k.join(r,fe,Re),i=k.join(r,fe,Ce);H=new oe({sourceDirectory:r,workerModulePath:n,invalidWorkerModulePath:i});let u=ee.PROD_SERVER_PORT;a?.port&&(u=parseInt(a.port),A.info(`Using passed in port of: ${a.port}`)),We=new De({port:u,handler:Dr}),await We.listenAndServe()}e(Fe,"start");async function $e(){await H.init()}e($e,"postStart");function Dr(a){return a.url&&a.url.endsWith("__/zuplo/reload")?H.reloadScript(a):a.url&&a.url.endsWith("__/zuplo/invalid-build")?H.invalidateScript(a):H.execute(a)}e(Dr,"handler");await Te({export:!0,allowEmptyValues:!0,examplePath:""});await A.setup({handlers:{console:new Q("DEBUG")},loggers:{default:{level:"DEBUG",handlers:["console"]}}});var Be=Pe(Deno.args),wr=Fe({sourceDirectory:Be.sourceDirectory,port:Be.port}),xr=$e();await Promise.all([wr,xr]);
